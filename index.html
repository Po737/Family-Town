<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®å§¨éº»ä¹‹å®¶</title>
    <!-- æ·»åŠ  Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.1.0/firebase-database.js"></script>
    <!-- Firebase é…ç½®å’Œåˆå§‹åŒ– -->
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDn3h8nSffSlKaCRo7vKJ8_zfTin0W_qC4",
            authDomain: "bym-family.firebaseapp.com",
            databaseURL: "https://bym-family-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "bym-family",
            storageBucket: "bym-family.firebasestorage.app",
            messagingSenderId: "45016314383",
            appId: "1:45016314383:web:fdb3e2a833f820b255297a",
            measurementId: "G-3216GG72ZM"
        };

        // åˆå§‹åŒ– Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database(app);
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #ffc0cb 0%, #e0f6ff 50%, #ffffff 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ç™»å½•åçš„èƒŒæ™¯ - èåˆåŸèƒŒæ™¯è‰²å’Œå›¾ç‰‡ */
        body.logged-in {
            background: 
                linear-gradient(135deg, rgba(255, 192, 203, 0.7) 0%, rgba(224, 246, 255, 0.7) 50%, rgba(255, 255, 255, 0.7) 100%),
                url('./mbg.jpg');
            background-size: cover, cover;
            background-position: center, center;
            background-repeat: no-repeat, no-repeat;
            background-attachment: fixed, fixed;
        }

        .container {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 40px;
            width: 90%;
            max-width: 800px;
            backdrop-filter: blur(10px);
        }

        /* ç™»å½•åå®¹å™¨èƒŒæ™¯è°ƒæ•´ */
        body.logged-in .container {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(15px);
        }

        .login-container {
            text-align: center;
            background-image: url('./bg.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            border-radius: 20px;
            padding: 40px;
            position: relative;
        }

        .login-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.85);
            border-radius: 20px;
            z-index: 1;
        }

        .login-container > * {
            position: relative;
            z-index: 2;
        }

        .main-container {
            display: none;
        }

        .history-container {
            display: none;
        }

        h1 {
            color: #ff69b4;
            margin-bottom: 30px;
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
            max-width: 300px;
            margin: 0 auto;
        }

        .login-form input {
            padding: 15px;
            border: 2px solid #ffc0cb;
            border-radius: 10px;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.9);
            transition: all 0.3s ease;
        }

        .login-form input:focus {
            outline: none;
            border-color: #87ceeb;
            box-shadow: 0 0 10px rgba(135, 206, 235, 0.3);
        }

        .login-btn {
            background: linear-gradient(45deg, #ffc0cb, #87ceeb);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .login-btn:hover {
            transform: translateY(-2px);
        }

        .user-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding: 20px;
            background: rgba(255, 192, 203, 0.2);
            border-radius: 15px;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
        }

        .nav-btn, .logout-btn {
            background: #ff69b4;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s ease;
            font-size: 14px;
        }

        .nav-btn:hover, .logout-btn:hover {
            background: #ff1493;
        }

        .nav-btn.active {
            background: #87ceeb;
        }

        .nav-btn.active:hover {
            background: #4682b4;
        }

        .avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid #fff;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            background-color: #fff;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        .mankit-avatar {
            background-image: url('./manicon.png');
        }

        .po-avatar {
            background-image: url('./poicon.png');
        }

        .message-form {
            margin-bottom: 25px;
            padding: 25px;
            background: rgba(135, 206, 235, 0.1);
            border-radius: 15px;
        }

        .message-input {
            width: 100%;
            min-height: 120px;
            padding: 15px;
            border: 2px solid #87ceeb;
            border-radius: 10px;
            font-size: 16px;
            resize: vertical;
            background: rgba(255, 255, 255, 0.9);
            margin-bottom: 15px;
        }

        /* æ–°å¢ï¼šæ¶ˆæ¯è¾“å…¥æ¡†åº•éƒ¨æ§åˆ¶åŒº */
        .message-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
        }

        /* æ–°å¢ï¼šè¡¨æƒ…æŒ‰é’® */
        .emoji-btn {
            background: rgba(255, 192, 203, 0.6);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            position: relative;
        }

        .emoji-btn:hover {
            background: rgba(255, 192, 203, 0.8);
            transform: scale(1.1);
        }

        /* æ–°å¢ï¼šè¡¨æƒ…é€‰æ‹©é¢æ¿ - å¢å¤§é¢ç§¯ä»¥é¿å…æ»šåŠ¨ */
        .emoji-panel {
            position: absolute;
            bottom: 60px;
            left: 0;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            display: none;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
            width: 480px;
            max-height: none; // ç§»é™¤é«˜åº¦é™åˆ¶ï¼Œé¿å…æ»šåŠ¨
            overflow-y: visible; // å…è®¸å†…å®¹æº¢å‡º
            z-index: 1000;
        }

        .emoji-panel.show {
            display: grid;
        }

        .emoji-item {
            width: 80px;
            height: 80px;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 192, 203, 0.1);
            overflow: hidden;
        }

        .emoji-item:hover {
            background: rgba(255, 192, 203, 0.3);
            transform: scale(1.1);
        }

        .emoji-item img {
            width: 70px;
            height: 70px;
            object-fit: contain;
            /* ç¡®ä¿GIFå¾ªç¯æ’­æ”¾ */
            animation-iteration-count: infinite;
        }

        .send-btn {
            background: linear-gradient(45deg, #87ceeb, #ffc0cb);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .send-btn:hover {
            transform: translateY(-2px);
        }

        .messages {
            max-height: 400px;
            overflow-y: auto;
            padding: 20px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 15px;
        }

        .week-info {
            text-align: center;
            margin-bottom: 15px;
            padding: 10px 15px;
            background: rgba(255, 182, 193, 0.3);
            border-radius: 10px;
            color: #666;
            font-size: 14px;
        }

        .message {
            margin-bottom: 20px;
            padding: 20px;
            border-radius: 15px;
            animation: fadeIn 0.5s ease-in;
            position: relative;
        }

        .message.po {
            background: rgba(255, 192, 203, 0.3);
            margin-right: 20px;
        }

        .message.mankit {
            background: rgba(135, 206, 235, 0.3);
            margin-left: 20px;
        }

        .message-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            gap: 10px;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #fff;
            background-color: #fff;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        .message-user {
            font-weight: bold;
            color: #333;
        }

        .message-time {
            color: #666;
            font-size: 12px;
            margin-left: auto;
        }

        .message-content {
            color: #444;
            line-height: 1.5;
            word-wrap: break-word;
        }

        /* ä¿®æ”¹ï¼šæ¶ˆæ¯ä¸­çš„è¡¨æƒ…æ ·å¼ï¼Œç¡®ä¿GIFå¾ªç¯æ’­æ”¾ */
        .message-sticker {
            width: 100px;
            height: 100px;
            object-fit: contain;
            border-radius: 10px;
            /* å¼ºåˆ¶GIFå¾ªç¯æ’­æ”¾ */
            animation-iteration-count: infinite;
            background: transparent;
        }

        /* æ–°å¢ï¼šåˆ é™¤æŒ‰é’®æ ·å¼ */
        .delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: transparent;
            border: none;
            color: #ff4444;
            font-size: 16px;
            cursor: pointer;
            padding: 0 5px;
            display: none;
        }

        .message:hover .delete-btn {
            display: block;
        }

        .error {
            color: #ff4444;
            text-align: center;
            margin-top: 10px;
        }

        /* å†å²æ¶ˆæ¯æ ·å¼ */
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 20px;
            background: rgba(135, 206, 235, 0.2);
            border-radius: 15px;
        }

        .back-btn {
            background: #87ceeb;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .back-btn:hover {
            background: #4682b4;
        }

        .history-stats {
            color: #666;
            font-size: 14px;
        }

        .week-section {
            margin-bottom: 30px;
            border: 2px solid rgba(255, 182, 193, 0.3);
            border-radius: 15px;
            overflow: hidden;
        }

        .week-header {
            background: rgba(255, 182, 193, 0.3);
            padding: 15px 20px;
            font-weight: bold;
            color: #666;
            cursor: pointer;
            transition: background 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .week-header:hover {
            background: rgba(255, 182, 193, 0.5);
        }

        .week-header.expanded {
            background: rgba(255, 182, 193, 0.6);
        }

        .week-messages {
            display: none;
            padding: 20px;
            background: rgba(255, 255, 255, 0.3);
            max-height: 300px;
            overflow-y: auto;
        }

        .week-messages.expanded {
            display: block;
        }

        .expand-icon {
            transition: transform 0.3s ease;
        }

        .expand-icon.expanded {
            transform: rotate(90deg);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ===== æ–°å¢ï¼šå·¦ä¾§é¢æ¿æ ·å¼ ===== */
        .left-sidebar {
            display: none; /* ç™»å½•å‰éšè— */
            position: fixed;
            left: 20px;
            top: 20px;
            width: 280px;
            height: calc(100vh - 40px);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            overflow-y: auto;
        }

        body.logged-in .left-sidebar {
            display: block;
        }

        /* ç¼©çŸ­è·ç¦»ï¼Œè®©ä¸»ç•Œé¢æ›´å±…ä¸­ */
        body.logged-in .container {
            margin-left: 250px;
        }

        /* Daily Mood æ¨¡å— */
        .mood-module {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            border-radius: 15px;
            padding: 15px; /* ä¿®æ”¹ï¼šå‡å°‘padding */
            margin-bottom: 20px;
            color: white;
            box-shadow: 0 8px 25px rgba(255, 154, 158, 0.3);
        }

        .mood-header {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px; /* ä¿®æ”¹ï¼šå‡å°‘margin */
            cursor: pointer;
            padding: 8px; /* ä¿®æ”¹ï¼šå‡å°‘padding */
            border-radius: 10px;
            transition: all 0.3s;
            user-select: none;
        }

        .mood-header:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        /* ä¿®æ”¹ï¼šå‡å°‘marginä»¥å¢åŠ æ˜¾ç¤ºç©ºé—´ */
        .mood-display {
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin-bottom: 8px; /* ä¿®æ”¹ï¼šè¿›ä¸€æ­¥å‡å°‘margin */
            padding: 8px; /* ä¿®æ”¹ï¼šå‡å°‘padding */
            background: rgba(255, 255, 255, 0.2);
            border-radius: 12px;
        }

        .user-mood-display {
            text-align: center;
            flex: 1;
        }

        .user-mood-label {
            font-size: 12px;
            margin-bottom: 5px; /* ä¿®æ”¹ï¼šå‡å°‘margin */
            opacity: 0.9;
            font-weight: bold;
        }

        /* ä¿®æ”¹ï¼šç¡®ä¿GIFå¯ä»¥åŠ¨æ€æ˜¾ç¤ºå¹¶å¼ºåˆ¶å¾ªç¯æ’­æ”¾ */
        .mood-gif {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid rgba(255, 255, 255, 0.6);
            transition: all 0.3s;
            cursor: pointer;
            background: white;
            /* ç¡®ä¿GIFå¯ä»¥æ­£å¸¸å¾ªç¯æ’­æ”¾ */
            image-rendering: auto;
            animation-iteration-count: infinite;
        }

        .mood-gif:hover {
            transform: scale(1.1);
            border-color: rgba(255, 255, 255, 0.9);
        }

        /* ä¿®æ”¹ï¼šåªæœ‰å½“å‰ç”¨æˆ·å¯ä»¥ç‚¹å‡»è‡ªå·±çš„å¤´åƒ */
        .mood-gif.clickable {
            cursor: pointer;
        }

        /* ä¿®æ”¹ï¼š4*3å¸ƒå±€ï¼Œæ— éœ€æ»šåŠ¨ */
        .mood-selector {
            display: none;
            grid-template-columns: repeat(4, 1fr); /* ä¿®æ”¹ï¼š4åˆ—å¸ƒå±€ */
            gap: 6px; /* ä¿®æ”¹ï¼šå‡å°‘é—´è· */
            margin-top: 8px; /* ä¿®æ”¹ï¼šå‡å°‘margin */
            padding: 8px; /* ä¿®æ”¹ï¼šå‡å°‘padding */
            background: rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            max-height: none; /* ä¿®æ”¹ï¼šç§»é™¤æ»šåŠ¨é™åˆ¶ */
            overflow: visible; /* ä¿®æ”¹ï¼šç§»é™¤æ»šåŠ¨ */
        }

        .mood-selector.show {
            display: grid;
        }

        /* ä¿®æ”¹ï¼šç¼©å°emojiæŒ‰é’® */
        .mood-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 6px 3px; /* ä¿®æ”¹ï¼šå‡å°‘padding */
            border-radius: 8px; /* ä¿®æ”¹ï¼šç¼©å°åœ†è§’ */
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(255, 255, 255, 0.1);
        }

        .mood-option:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px); /* ä¿®æ”¹ï¼šå‡å°‘ç§»åŠ¨è·ç¦» */
        }

        .mood-option .emoji {
            font-size: 20px; /* ä¿®æ”¹ï¼šç¼©å°emoji */
            margin-bottom: 3px; /* ä¿®æ”¹ï¼šå‡å°‘margin */
        }

        .mood-option span {
            font-size: 8px; /* ä¿®æ”¹ï¼šç¼©å°å­—ä½“ */
            text-align: center;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        .mood-history-btn {
            background: rgba(255, 255, 255, 0.25);
            border: none;
            color: white;
            padding: 6px 12px; /* ä¿®æ”¹ï¼šå‡å°‘padding */
            border-radius: 20px;
            cursor: pointer;
            font-size: 11px; /* ä¿®æ”¹ï¼šç¼©å°å­—ä½“ */
            margin-top: 6px; /* ä¿®æ”¹ï¼šå‡å°‘margin */
            width: 100%;
            transition: all 0.3s;
            font-weight: bold;
        }

        .mood-history-btn:hover {
            background: rgba(255, 255, 255, 0.4);
            transform: translateY(-2px);
        }

        /* ä»Šå¤©åƒä»€ä¹ˆæ¨¡å— */
        .food-module {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            border-radius: 15px;
            padding: 20px;
            color: #333;
            box-shadow: 0 8px 25px rgba(168, 237, 234, 0.3);
        }

        .food-header {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            cursor: pointer;
            padding: 10px;
            border-radius: 10px;
            transition: all 0.3s;
            user-select: none;
            color: #444;
        }

        .food-header:hover {
            background: rgba(255, 255, 255, 0.4);
            transform: translateY(-2px);
        }

        .food-display {
            text-align: center;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 15px;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.4);
            border-radius: 12px;
            padding: 15px;
            color: #555;
            border: 2px dashed rgba(255, 255, 255, 0.6);
        }

        .food-options {
            display: none;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 15px;
        }

        .food-options.show {
            display: grid;
        }

        .food-option {
            padding: 12px 8px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            font-size: 13px;
            font-weight: bold;
            color: #555;
            border: 1px solid rgba(255, 255, 255, 0.4);
        }

        .food-option:hover {
            background: rgba(255, 255, 255, 0.6);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        /* æ–°å¢ï¼šå¿ƒæƒ…å†å²æ¨¡æ€æ¡†æ ·å¼ - è°ƒæ•´ä¸ºæ¸©é¦¨è®¾è®¡ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 192, 203, 0.4);
        }

        .modal-content {
            background-color: rgba(255, 255, 255, 0.9);
            background-size: cover;
            background-position: center;
            margin: 15% auto;
            padding: 20px;
            border: none;
            width: 80%;
            max-width: 600px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            color: #ff69b4;
        }

        .close-btn {
            color: #ff69b4;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-btn:hover {
            color: #ff1493;
        }

        .calendar-table {
            width: 100%;
            border-collapse: collapse;
        }

        .calendar-table th, .calendar-table td {
            border: 1px solid rgba(255, 182, 193, 0.3);
            padding: 8px;
            text-align: center;
            color: #666;
        }

        .calendar-table td img {
            width: 20px;
            height: 20px;
            margin: 2px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 20px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .user-info {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .nav-buttons {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .message.po {
                margin-right: 0;
            }
            
            .message.mankit {
                margin-left: 0;
            }

            /* ç§»åŠ¨ç«¯éšè—å·¦ä¾§é¢æ¿æˆ–è°ƒæ•´å¸ƒå±€ */
            .left-sidebar {
                display: none !important;
            }

            body.logged-in .container {
                margin-left: 0;
            }

            /* ç§»åŠ¨ç«¯è¡¨æƒ…é¢æ¿è°ƒæ•´ */
            .emoji-panel {
                width: 320px;
                grid-template-columns: repeat(5, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- ===== æ–°å¢ï¼šå·¦ä¾§é¢æ¿ ===== -->
    <div class="left-sidebar" id="leftSidebar">
        <!-- Daily Mood æ¨¡å— -->
        <div class="mood-module">
            <div class="mood-header" onclick="toggleMoodSelector()">
                ğŸŒˆ Daily Mood
            </div>
            
            <!-- å½“å‰å¿ƒæƒ…æ˜¾ç¤º -->
            <div class="mood-display">
                <div class="user-mood-display">
                    <div class="user-mood-label">Po</div>
                    <img id="po-mood" class="mood-gif" src="dailyemo/normal.gif" alt="Po's mood" onclick="setCurrentUser('po')">
                </div>
                <div class="user-mood-display">
                    <div class="user-mood-label">Mankit</div>
                    <img id="mankit-mood" class="mood-gif" src="dailyemo/normal.gif" alt="Mankit's mood" onclick="setCurrentUser('mankit')">
                </div>
            </div>
            
            <!-- å¿ƒæƒ…é€‰æ‹©å™¨ - 4*3å¸ƒå±€ -->
            <div id="mood-selector" class="mood-selector">
                <div class="mood-option" onclick="selectMood('angry')">
                    <div class="emoji">ğŸ˜ </div>
                    <span>ç”Ÿæ°”</span>
                </div>
                <div class="mood-option" onclick="selectMood('hateu')">
                    <div class="emoji">ğŸ˜¤</div>
                    <span>è®¨åŒä½ </span>
                </div>
                <div class="mood-option" onclick="selectMood('sad')">
                    <div class="emoji">ğŸ˜¢</div>
                    <span>éš¾è¿‡</span>
                </div>
                <div class="mood-option" onclick="selectMood('happy')">
                    <div class="emoji">ğŸ˜Š</div>
                    <span>å¼€å¿ƒ</span>
                </div>
                <div class="mood-option" onclick="selectMood('proud')">
                    <div class="emoji">ğŸ˜</div>
                    <span>å¾—æ„</span>
                </div>
                <div class="mood-option" onclick="selectMood('normal')">
                    <div class="emoji">ğŸ˜</div>
                    <span>å¹³å¸¸</span>
                </div>
                <div class="mood-option" onclick="selectMood('loveu')">
                    <div class="emoji">ğŸ˜</div>
                    <span>çˆ±ä½ </span>
                </div>
                <div class="mood-option" onclick="selectMood('sleepy')">
                    <div class="emoji">ğŸ˜´</div>
                    <span>å›°å›°</span>
                </div>
                <div class="mood-option" onclick="selectMood('weak')">
                    <div class="emoji">ğŸ¤’</div>
                    <span>è™šå¼±</span>
                </div>
                <div class="mood-option" onclick="selectMood('hardwork')">
                    <div class="emoji">ğŸ’ª</div>
                    <span>å·¥ä½œ</span>
                </div>
            </div>
            
            <button class="mood-history-btn" onclick="showMoodHistory()">ğŸ“Š å¿ƒæƒ…å†å²</button>
        </div>

        <!-- ä»Šå¤©åƒä»€ä¹ˆæ¨¡å— -->
        <div class="food-module">
            <div class="food-header" onclick="toggleFoodOptions()">
                ğŸ½ï¸ ä»Šå¤©åƒä»€ä¹ˆ
            </div>
            
            <div id="food-display" class="food-display">
                ç‚¹å‡»ä¸Šæ–¹å¼€å§‹é€‰æ‹©ç¾é£Ÿï¼ ğŸ¯
            </div>
            
            <div id="food-options" class="food-options">
                <div class="food-option" onclick="selectFood('ä¸­é¤')">ğŸ¥¢ ä¸­é¤</div>
                <div class="food-option" onclick="selectFood('è¥¿é¤')">ğŸ è¥¿é¤</div>
                <div class="food-option" onclick="selectFood('æ—¥æ–™')">ğŸ£ æ—¥æ–™</div>
                <div class="food-option" onclick="selectFood('éŸ©é¤')">ğŸœ éŸ©é¤</div>
                <div class="food-option" onclick="selectFood('ç«é”…')">ğŸ² ç«é”…</div>
                <div class="food-option" onclick="selectFood('çƒ§çƒ¤')">ğŸ– çƒ§çƒ¤</div>
                <div class="food-option" onclick="selectFood('å¿«é¤')">ğŸ” å¿«é¤</div>
                <div class="food-option" onclick="selectFood('ç”œå“')">ğŸ° ç”œå“</div>
                <div class="food-option" onclick="selectFood('éšæœº')">ğŸ² éšæœº</div>
                <div class="food-option" onclick="selectFood('å¤–å–')">ğŸ“± å¤–å–</div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- ç™»å½•ç•Œé¢ -->
        <div class="login-container" id="loginContainer">
            <h1>ğŸ’• å®å§¨éº»ä¹‹å®¶ ğŸ’•</h1>
            <div class="login-form">
                <input type="text" id="username" placeholder="ç”¨æˆ·å" />
                <input type="password" id="password" placeholder="å¯†ç " />
                <button class="login-btn" onclick="login()">ç™»å½•</button>
                <div class="error" id="loginError"></div>
            </div>
        </div>

        <!-- ä¸»ç•Œé¢ -->
        <div class="main-container" id="mainContainer">
            <div class="user-info">
                <div class="user-profile">
                    <div class="avatar" id="userAvatar"></div>
                    <div>
                        <div>æ¬¢è¿å›æ¥ï¼Œ<span id="currentUser"></span> â¤ï¸</div>
                    </div>
                </div>
                <div class="nav-buttons">
                    <button class="nav-btn active" id="currentBtn" onclick="showCurrent()">æœ¬å‘¨å¯¹è¯</button>
                    <button class="nav-btn" id="historyBtn" onclick="showHistory()">å†å²è®°å½•</button>
                    <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
                </div>
            </div>

            <div class="week-info" id="weekInfo"></div>

            <div class="message-form">
                <textarea class="message-input" id="messageInput" placeholder="å†™ä¸‹ä½ æƒ³è¯´çš„è¯..."></textarea>
                <!-- ä¿®æ”¹ï¼šæ¶ˆæ¯æ§åˆ¶åŒºåŸŸ -->
                <div class="message-controls">
                    <div style="position: relative;">
                        <button class="emoji-btn" onclick="toggleEmojiPanel()">ğŸ˜Š</button>
                        <!-- ä¿®æ”¹ï¼šè¡¨æƒ…é€‰æ‹©é¢æ¿ï¼Œä¿®æ­£è·¯å¾„ä¸ºBYM/sticker/*.gif -->
                        <div id="emoji-panel" class="emoji-panel">
                            <div class="emoji-item" onclick="sendSticker('cheers')" title="cheers">
                                <img src="sticker/cheers.gif" alt="cheers">
                            </div>
                            <div class="emoji-item" onclick="sendSticker('cry')" title="cry">
                                <img src="sticker/cry.gif" alt="cry">
                            </div>
                            <div class="emoji-item" onclick="sendSticker('cute')" title="cute">
                                <img src="sticker/cute.gif" alt="cute">
                            </div>
                            <div class="emoji-item" onclick="sendSticker('dancing')" title="dancing">
                                <img src="sticker/dancing.gif" alt="dancing">
                            </div>
                            <div class="emoji-item" onclick="sendSticker('friends')" title="friends">
                                <img src="sticker/friends.gif" alt="friends">
                            </div>
                            <div class="emoji-item" onclick="sendSticker('gotit')" title="gotit">
                                <img src="sticker/gotit.gif" alt="gotit">
                            </div>
                            <div class="emoji-item" onclick="sendSticker('harkwork')" title="harkwork">
                                <img src="sticker/harkwork.gif" alt="harkwork">
                            </div>
                            <div class="emoji-item" onclick="sendSticker('loveu')" title="loveu">
                                <img src="sticker/loveu.gif" alt="loveu">
                            </div>
                            <div class="emoji-item" onclick="sendSticker('manner')" title="manner">
                                <img src="sticker/manner.gif" alt="manner">
                            </div>
                            <div class="emoji-item" onclick="sendSticker('money')" title="money">
                                <img src="sticker/money.gif" alt="money">
                            </div>
                            <div class="emoji-item" onclick="sendSticker('no_energy')" title="no_energy">
                                <img src="sticker/no_energy.gif" alt="no_energy">
                            </div>
                            <div class="emoji-item" onclick="sendSticker('ok')" title="ok">
                                <img src="sticker/ok.gif" alt="ok">
                            </div>
                            <div class="emoji-item" onclick="sendSticker('play')" title="play">
                                <img src="sticker/play.gif" alt="play">
                            </div>
                            <div class="emoji-item" onclick="sendSticker('poor')" title="poor">
                                <img src="sticker/poor.gif" alt="poor">
                            </div>
                            <div class="emoji-item" onclick="sendSticker('sleepy')" title="sleepy">
                                <img src="sticker/sleepy.gif" alt="sleepy">
                            </div>
                            <div class="emoji-item" onclick="sendSticker('sorry')" title="sorry">
                                <img src="sticker/sorry.gif" alt="sorry">
                            </div>
                            <div class="emoji-item" onclick="sendSticker('still')" title="still">
                                <img src="sticker/still.gif" alt="still">
                            </div>
                            <div class="emoji-item" onclick="sendSticker('takecare')" title="takecare">
                                <img src="sticker/takecare.gif" alt="takecare">
                            </div>
                            <div class="emoji-item" onclick="sendSticker('thanks')" title="thanks">
                                <img src="sticker/thanks.gif" alt="thanks">
                            </div>
                            <div class="emoji-item" onclick="sendSticker('tietie')" title="tietie">
                                <img src="sticker/tietie.gif" alt="tietie">
                            </div>
                            <div class="emoji-item" onclick="sendSticker('together')" title="together">
                                <img src="sticker/together.gif" alt="together">
                            </div>
                            <div class="emoji-item" onclick="sendSticker('toutou')" title="toutou">
                                <img src="sticker/toutou.gif" alt="toutou">
                            </div>
                            <div class="emoji-item" onclick="sendSticker('woc')" title="woc">
                                <img src="sticker/woc.gif" alt="woc">
                            </div>
                            <div class="emoji-item" onclick="sendSticker('yummy')" title="yummy">
                                <img src="sticker/yummy.gif" alt="yummy">
                            </div>
                        </div>
                    </div>
                    <button class="send-btn" onclick="sendMessage()">å‘é€æ¶ˆæ¯ ğŸ’Œ</button>
                </div>
            </div>

            <div class="messages" id="messages"></div>
        </div>

        <!-- å†å²æ¶ˆæ¯ç•Œé¢ -->
        <div class="history-container" id="historyContainer">
            <div class="history-header">
                <button class="back-btn" onclick="showCurrent()">â† è¿”å›å½“å‰å¯¹è¯</button>
                <h2 style="color: #ff69b4; margin: 0;">å†å²è®°å½• ğŸ“š</h2>
                <div class="history-stats" id="historyStats"></div>
            </div>
            
            <div id="historyContent"></div>
        </div>
    </div>

    <!-- æ–°å¢ï¼šå¿ƒæƒ…å†å²æ¨¡æ€æ¡† -->
    <div id="moodModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="document.getElementById('moodModal').style.display='none'">&times;</span>
            <h2>æœ¬æœˆå¿ƒæƒ…æ—¥å†</h2>
            <div id="calendarContainer"></div>
        </div>
    </div>

    <script>
        // ç”¨æˆ·æ•°æ®
        const users = {
            'po': {
                password: '0526',
                avatar: 'po-avatar',
                name: 'Po'
            },
            'mankit': {
                password: '1117',
                avatar: 'mankit-avatar',
                name: 'Mankit'
            }
        };

        // å…¨å±€å˜é‡åˆå§‹åŒ–
        let currentUser = null;
        let allMessages = [];

        // ===== æ–°å¢ï¼šå¿ƒæƒ…å’Œé£Ÿç‰©åŠŸèƒ½å˜é‡ =====
        let moodCurrentUser = 'po'; // å½“å‰è¦è®¾ç½®å¿ƒæƒ…çš„ç”¨æˆ·

        // è·å–å½“å‰å‘¨çš„å¼€å§‹å’Œç»“æŸæ—¶é—´
        function getCurrentWeekRange() {
            const now = new Date();
            const dayOfWeek = now.getDay();
            const startOfWeek = new Date(now);
            startOfWeek.setDate(now.getDate() - dayOfWeek);
            startOfWeek.setHours(0, 0, 0, 0);
            
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            endOfWeek.setHours(23, 59, 59, 999);
            
            return { start: startOfWeek, end: endOfWeek };
        }

        // è·å–æŸä¸ªæ—¥æœŸæ‰€åœ¨å‘¨çš„èŒƒå›´
        function getWeekRange(date) {
            const dayOfWeek = date.getDay();
            const startOfWeek = new Date(date);
            startOfWeek.setDate(date.getDate() - dayOfWeek);
            startOfWeek.setHours(0, 0, 0, 0);
            
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            endOfWeek.setHours(23, 59, 59, 999);
            
            return { start: startOfWeek, end: endOfWeek };
        }

        // æ ¼å¼åŒ–å‘¨èŒƒå›´æ˜¾ç¤º
        function formatWeekRange(start, end) {
            const options = { month: 'short', day: 'numeric' };
            return `${start.toLocaleDateString('zh-CN', options)} - ${end.toLocaleDateString('zh-CN', options)}`;
        }

        // æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦åœ¨å½“å‰å‘¨
        function isCurrentWeek(messageDate) {
            const currentWeek = getCurrentWeekRange();
            return messageDate >= currentWeek.start && messageDate <= currentWeek.end;
        }

        // è·å–å½“å‰å‘¨æ¶ˆæ¯
        function getCurrentWeekMessages() {
            return allMessages.filter(msg => isCurrentWeek(new Date(msg.timestamp)));
        }

        // è·å–å†å²æ¶ˆæ¯ï¼ˆæŒ‰å‘¨åˆ†ç»„ï¼‰
        function getHistoryMessages() {
            const historyMessages = allMessages.filter(msg => !isCurrentWeek(new Date(msg.timestamp)));
            const messagesByWeek = {};
            
            historyMessages.forEach(msg => {
                const msgDate = new Date(msg.timestamp);
                const weekRange = getWeekRange(msgDate);
                const weekKey = `${weekRange.start.getTime()}-${weekRange.end.getTime()}`;
                
                if (!messagesByWeek[weekKey]) {
                    messagesByWeek[weekKey] = {
                        start: weekRange.start,
                        end: weekRange.end,
                        messages: []
                    };
                }
                
                messagesByWeek[weekKey].messages.push(msg);
            });
            
            // æŒ‰æ—¶é—´å€’åºæ’åˆ—ï¼ˆæœ€æ–°çš„å‘¨åœ¨å‰é¢ï¼‰
            return Object.values(messagesByWeek).sort((a, b) => b.start.getTime() - a.start.getTime());
        }

        // ä¿®æ”¹ï¼šä½¿ç”¨ Firebase ä¿å­˜æ¶ˆæ¯
        function saveMessages() {
            const messagesRef = database.ref('messages');
            messagesRef.set(allMessages); // è¦†ç›–æ•´ä¸ªæ•°ç»„
        }

        // ä¿®æ”¹ï¼šä½¿ç”¨ Firebase åŠ è½½æ¶ˆæ¯ï¼ˆå®æ—¶åŒæ­¥ï¼‰
        function loadMessages() {
            const messagesRef = database.ref('messages');
            messagesRef.on('value', (snapshot) => {
                allMessages = snapshot.val() || [];
                // ç¡®ä¿æ‰€æœ‰æ¶ˆæ¯éƒ½æœ‰æœ‰æ•ˆçš„æ—¶é—´æˆ³
                allMessages.forEach(msg => {
                    if (typeof msg.timestamp === 'string' && !msg.timestamp.includes('T')) {
                        msg.timestamp = new Date(msg.timestamp).toISOString();
                    }
                });
                // åˆ·æ–°ç•Œé¢
                updateWeekInfo();
                displayCurrentMessages();
            });
        }

        // åˆå§‹åŒ–åº”ç”¨
        function initApp() {
            loadMessages(); // ç°åœ¨ä» Firebase åŠ è½½
            updateWeekInfo();
            displayCurrentMessages();
            // ===== æ–°å¢ï¼šåˆå§‹åŒ–å¿ƒæƒ…å’Œé£Ÿç‰©æ¨¡å— =====
            loadTodayMood();
            loadTodayFood();
            updateMoodPermissions(); // æ–°å¢ï¼šæ›´æ–°æƒé™æ§åˆ¶
        }

        // æ›´æ–°å‘¨ä¿¡æ¯
        function updateWeekInfo() {
            const weekInfo = document.getElementById('weekInfo');
            const currentWeek = getCurrentWeekRange();
            const currentMessages = getCurrentWeekMessages();
            
            weekInfo.innerHTML = `
                ğŸ“… æœ¬å‘¨å¯¹è¯ (${formatWeekRange(currentWeek.start, currentWeek.end)}) 
                <br>å…± ${currentMessages.length} æ¡æ¶ˆæ¯
            `;
        }

        // æ˜¾ç¤ºå½“å‰å‘¨æ¶ˆæ¯
        function showCurrent() {
            document.getElementById('mainContainer').style.display = 'block';
            document.getElementById('historyContainer').style.display = 'none';
            document.getElementById('currentBtn').classList.add('active');
            document.getElementById('historyBtn').classList.remove('active');
            displayCurrentMessages();
        }

        // æ˜¾ç¤ºå†å²è®°å½•
        function showHistory() {
            document.getElementById('mainContainer').style.display = 'none';
            document.getElementById('historyContainer').style.display = 'block';
            document.getElementById('currentBtn').classList.remove('active');
            document.getElementById('historyBtn').classList.add('active');
            displayHistoryMessages();
        }

        // ä¿®æ”¹ï¼šç™»å½•åŠŸèƒ½ - æ”¯æŒä¸åŒºåˆ†å¤§å°å†™
        function login() {
            const username = document.getElementById('username').value.trim().toLowerCase(); // è½¬æ¢ä¸ºå°å†™
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('loginError');

            if (!username || !password) {
                errorDiv.textContent = 'è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ';
                return;
            }

            // æŸ¥æ‰¾ç”¨æˆ·æ—¶ä¹Ÿè½¬æ¢ä¸ºå°å†™æ¯”è¾ƒ
            const foundUser = Object.keys(users).find(key => key.toLowerCase() === username);
            
            if (foundUser && users[foundUser].password === password) {
                currentUser = foundUser; // ä½¿ç”¨åŸå§‹çš„ç”¨æˆ·åï¼ˆä¿æŒå¤§å°å†™ï¼‰
                showMainInterface();
                errorDiv.textContent = '';
            } else {
                errorDiv.textContent = 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯';
            }
        }

        // æ˜¾ç¤ºä¸»ç•Œé¢
        function showMainInterface() {
            // æ·»åŠ ç™»å½•åçš„èƒŒæ™¯æ ·å¼
            document.body.classList.add('logged-in');
            
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('mainContainer').style.display = 'block';
            
            const userAvatar = document.getElementById('userAvatar');
            const currentUserSpan = document.getElementById('currentUser');
            
            userAvatar.className = `avatar ${users[currentUser].avatar}`;
            currentUserSpan.textContent = users[currentUser].name;
            
            // ===== æ–°å¢ï¼šè®¾ç½®å½“å‰å¿ƒæƒ…é€‰æ‹©ç”¨æˆ· =====
            moodCurrentUser = currentUser;
            
            initApp();
        }

        // é€€å‡ºç™»å½•
        function logout() {
            // ç§»é™¤ç™»å½•åçš„èƒŒæ™¯æ ·å¼
            document.body.classList.remove('logged-in');
            
            currentUser = null;
            document.getElementById('loginContainer').style.display = 'block';
            document.getElementById('mainContainer').style.display = 'none';
            document.getElementById('historyContainer').style.display = 'none';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('loginError').textContent = '';
        }

        // å‘é€æ¶ˆæ¯
        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const content = messageInput.value.trim();

            if (!content) {
                alert('è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹');
                return;
            }

            const message = {
                user: currentUser,
                content: content,
                timestamp: new Date().toISOString(),
                type: 'text' // æ–°å¢ï¼šæ¶ˆæ¯ç±»å‹
            };

            // ä½¿ç”¨ Firebase push æ·»åŠ æ¶ˆæ¯
            database.ref('messages').push(message); // å®æ—¶æ·»åŠ åˆ°äº‘ç«¯

            messageInput.value = '';
            updateWeekInfo();
            displayCurrentMessages();
        }

        // ä¿®æ”¹ï¼šå‘é€è¡¨æƒ…è´´çº¸ï¼Œç¡®ä¿GIFè·¯å¾„æ­£ç¡®
        function sendSticker(stickerName) {
            const message = {
                user: currentUser,
                content: stickerName,
                timestamp: new Date().toISOString(),
                type: 'sticker' // æ–°å¢ï¼šè¡¨æƒ…ç±»å‹
            };

            // ä½¿ç”¨ Firebase push æ·»åŠ æ¶ˆæ¯
            database.ref('messages').push(message); // å®æ—¶æ·»åŠ åˆ°äº‘ç«¯

            updateWeekInfo();
            displayCurrentMessages();
            
            // å…³é—­è¡¨æƒ…é¢æ¿
            document.getElementById('emoji-panel').classList.remove('show');
        }

        // æ–°å¢ï¼šåˆ‡æ¢è¡¨æƒ…é¢æ¿
        function toggleEmojiPanel() {
            const panel = document.getElementById('emoji-panel');
            panel.classList.toggle('show');
        }

        // æ˜¾ç¤ºå½“å‰å‘¨æ¶ˆæ¯
        function displayCurrentMessages() {
            const messagesContainer = document.getElementById('messages');
            if (!messagesContainer) return;
            
            const currentMessages = getCurrentWeekMessages();
            messagesContainer.innerHTML = '';

            if (currentMessages.length === 0) {
                messagesContainer.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">æœ¬å‘¨è¿˜æ²¡æœ‰æ¶ˆæ¯ï¼Œå¿«æ¥å‘è¡¨ç¬¬ä¸€æ¡ç•™è¨€å§ï¼ğŸ’</div>';
                return;
            }

            currentMessages.forEach(message => {
                const messageDiv = createMessageElement(message);
                messagesContainer.appendChild(messageDiv);
            });

            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // æ˜¾ç¤ºå†å²æ¶ˆæ¯
        function displayHistoryMessages() {
            const historyContent = document.getElementById('historyContent');
            const historyStats = document.getElementById('historyStats');
            const historyData = getHistoryMessages();
            
            historyContent.innerHTML = '';
            
            if (historyData.length === 0) {
                historyContent.innerHTML = '<div style="text-align: center; color: #999; padding: 40px;">è¿˜æ²¡æœ‰å†å²è®°å½• ğŸ“­</div>';
                historyStats.textContent = 'æ€»è®¡: 0 æ¡å†å²æ¶ˆæ¯';
                return;
            }

            const totalHistoryMessages = historyData.reduce((sum, week) => sum + week.messages.length, 0);
            historyStats.textContent = `æ€»è®¡: ${totalHistoryMessages} æ¡å†å²æ¶ˆæ¯ï¼Œ${historyData.length} å‘¨`;

            historyData.forEach((weekData, index) => {
                const weekSection = document.createElement('div');
                weekSection.className = 'week-section';
                
                const weekHeader = document.createElement('div');
                weekHeader.className = 'week-header';
                weekHeader.innerHTML = `
                    <span>ğŸ“… ${formatWeekRange(weekData.start, weekData.end)} (${weekData.messages.length} æ¡æ¶ˆæ¯)</span>
                    <span class="expand-icon">â–¶</span>
                `;
                
                const weekMessages = document.createElement('div');
                weekMessages.className = 'week-messages';
                
                weekData.messages.forEach(message => {
                    const messageDiv = createMessageElement(message);
                    weekMessages.appendChild(messageDiv);
                });
                
                weekHeader.onclick = function() {
                    const isExpanded = weekMessages.classList.contains('expanded');
                    weekMessages.classList.toggle('expanded');
                    weekHeader.classList.toggle('expanded');
                    const icon = weekHeader.querySelector('.expand-icon');
                    icon.classList.toggle('expanded');
                };
                
                weekSection.appendChild(weekHeader);
                weekSection.appendChild(weekMessages);
                historyContent.appendChild(weekSection);
            });
        }

        // ä¿®æ”¹ï¼šåˆ›å»ºæ¶ˆæ¯å…ƒç´ ï¼Œä¿®æ­£è¡¨æƒ…è·¯å¾„ä¸ºsticker/*.gifï¼Œå¹¶æ·»åŠ åˆ é™¤æŒ‰é’®
        function createMessageElement(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${message.user}`;
            
            const messageTime = new Date(message.timestamp).toLocaleString('zh-CN');
            
            let contentHtml = '';
            if (message.type === 'sticker') {
                // ä¿®æ­£è·¯å¾„ä¸ºsticker/*.gifï¼Œå¹¶æ·»åŠ æ—¶é—´æˆ³ç¡®ä¿GIFé‡æ–°åŠ è½½
                contentHtml = `<img src="sticker/${message.content}.gif?t=${Date.now()}" alt="${message.content}" class="message-sticker" onload="this.style.animationPlayState='running'">`;
            } else {
                contentHtml = message.content;
            }
            
            messageDiv.innerHTML = `
                <div class="message-header">
                    <div class="message-avatar ${users[message.user].avatar}"></div>
                    <span class="message-user">${users[message.user].name}</span>
                    <span class="message-time">${messageTime}</span>
                </div>
                <div class="message-content">${contentHtml}</div>
            `;
            
            // æ–°å¢ï¼šå¦‚æœæ¶ˆæ¯æ˜¯å½“å‰ç”¨æˆ·å‘é€çš„ï¼Œæ·»åŠ åˆ é™¤æŒ‰é’®
            if (message.user === currentUser) {
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.innerHTML = 'Ã—';
                deleteBtn.onclick = function() {
                    if (confirm('ç¡®è®¤åˆ é™¤è¿™æ¡æ¶ˆæ¯å—ï¼Ÿ')) {
                        // ä»allMessagesä¸­ç§»é™¤è¯¥æ¶ˆæ¯
                        allMessages = allMessages.filter(msg => msg.timestamp !== message.timestamp);
                        saveMessages();
                        updateWeekInfo();
                        // åˆ·æ–°æ˜¾ç¤º
                        if (document.getElementById('mainContainer').style.display === 'block') {
                            displayCurrentMessages();
                        } else {
                            displayHistoryMessages();
                        }
                    }
                };
                messageDiv.appendChild(deleteBtn);
            }

            // æ–°å¢ï¼šå¦‚æœæ˜¯ä¸€ä¸ªstickerï¼Œæ·»åŠ intervalå¼ºåˆ¶é‡åŠ è½½ä»¥ä¿æŒåŠ¨ç”»
            if (message.type === 'sticker') {
                const img = messageDiv.querySelector('.message-sticker');
                setInterval(() => {
                    const baseSrc = img.src.split('?')[0];
                    img.src = baseSrc + '?t=' + Date.now();
                }, 5000); // æ¯5ç§’é‡åŠ è½½
            }
            
            return messageDiv;
        }

        // ===== æ–°å¢ï¼šæƒé™æ§åˆ¶å‡½æ•° =====
        function updateMoodPermissions() {
            const poMood = document.getElementById('po-mood');
            const mankitMood = document.getElementById('mankit-mood');
            
            // ç§»é™¤æ‰€æœ‰æƒé™ç±»
            poMood.classList.remove('clickable');
            mankitMood.classList.remove('clickable');
            
            // åªæœ‰å½“å‰ç”¨æˆ·å¯ä»¥ç‚¹å‡»è‡ªå·±çš„å¤´åƒ
            if (currentUser === 'po') {
                poMood.classList.add('clickable');
            } else if (currentUser === 'mankit') {
                mankitMood.classList.add('clickable');
            }
        }

        // ===== æ–°å¢ï¼šå¿ƒæƒ…åŠŸèƒ½å‡½æ•° =====
        function toggleMoodSelector() {
            const selector = document.getElementById('mood-selector');
            selector.classList.toggle('show');
        }

        // ä¿®æ”¹ï¼šåˆ é™¤æé†’å¼¹çª—ï¼Œä¿ç•™æƒé™æ§åˆ¶é€»è¾‘
        function setCurrentUser(user) {
            if (user !== currentUser) {
                return;
            }
            moodCurrentUser = user;
            const selector = document.getElementById('mood-selector');
            selector.classList.add('show');
        }

        function selectMood(moodType) {
            // ç¡®ä¿åªèƒ½è®¾ç½®è‡ªå·±çš„å¿ƒæƒ…
            if (moodCurrentUser !== currentUser) {
                return;
            }

            const moodGifs = {
                'angry': ['dailyemo/angry1.gif', 'dailyemo/angry2.gif'],
                'hateu': ['dailyemo/hateu.gif'],
                'sad': ['dailyemo/sad.gif'],
                'happy': ['dailyemo/happy1.gif', 'dailyemo/happy2.gif'],
                'proud': ['dailyemo/proud1.gif', 'dailyemo/proud2.gif', 'dailyemo/proud3.gif'],
                'normal': ['dailyemo/normal.gif'],
                'loveu': ['dailyemo/loveu.gif'],
                'sleepy': ['dailyemo/sleepy.gif'],
                'weak': ['dailyemo/weak.gif'],
                'hardwork': ['dailyemo/hardwork2.gif', 'dailyemo/harkwork1.gif']
            };

            // éšæœºé€‰æ‹©åŒç±»å‹çš„gif
            const gifs = moodGifs[moodType] || ['dailyemo/normal.gif'];
            const randomGif = gifs[Math.floor(Math.random() * gifs.length)];
            
            // æ›´æ–°å½“å‰ç”¨æˆ·çš„å¿ƒæƒ…æ˜¾ç¤º
            const userMoodImg = document.getElementById(currentUser + '-mood');
            userMoodImg.src = randomGif + '?t=' + Date.now(); // æ·»åŠ æ—¶é—´æˆ³å¼ºåˆ¶é‡æ–°åŠ è½½
            
            // å¼ºåˆ¶é‡æ–°åŠ è½½GIFä»¥ç¡®ä¿åŠ¨ç”»æ’­æ”¾
            userMoodImg.onload = function() {
                this.style.animationPlayState = 'running';
            };
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            const today = new Date().toDateString();
            localStorage.setItem(`${currentUser}_mood_${today}`, randomGif);
            
            // å…³é—­é€‰æ‹©å™¨
            document.getElementById('mood-selector').classList.remove('show');
            
            // ä¿å­˜åˆ°å†å²è®°å½•
            saveMoodHistory(currentUser, moodType, randomGif);
        }

        function saveMoodHistory(user, moodType, gif) {
            const today = new Date().toDateString();
            let history = JSON.parse(localStorage.getItem('mood_history') || '{}');
            
            if (!history[today]) {
                history[today] = {};
            }
            
            history[today][user] = {
                type: moodType,
                gif: gif,
                timestamp: new Date().toISOString()
            };
            
            localStorage.setItem('mood_history', JSON.stringify(history));
        }

        function showMoodHistory() {
            const history = JSON.parse(localStorage.getItem('mood_history') || '{}');
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth(); // 0-based
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const firstDay = new Date(year, month, 1).getDay();

            // è®¾ç½®å½“æœˆèƒŒæ™¯ï¼Œä¸­ä½é€æ˜åº¦
            const modalContent = document.querySelector('.modal-content');
            modalContent.style.backgroundImage = `linear-gradient(rgba(255, 255, 255, 0.5), rgba(255, 255, 255, 0.5)), url('cal/calendar${month + 1}.jpg')`;

            let calendarHtml = '<table class="calendar-table"><tr><th>æ—¥</th><th>ä¸€</th><th>äºŒ</th><th>ä¸‰</th><th>å››</th><th>äº”</th><th>å…­</th></tr><tr>';
            
            // æ·»åŠ ç©ºç™½æ ¼å­
            for (let i = 0; i < firstDay; i++) {
                calendarHtml += '<td></td>';
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = new Date(year, month, day).toDateString();
                let poImg = '';
                let mankitImg = '';
                
                if (history[dateStr]) {
                    if (history[dateStr].po) {
                        poImg = `<img src="${history[dateStr].po.gif}" alt="Po: ${history[dateStr].po.type}" title="Po: ${history[dateStr].po.type}">`;
                    }
                    if (history[dateStr].mankit) {
                        mankitImg = `<img src="${history[dateStr].mankit.gif}" alt="Mankit: ${history[dateStr].mankit.type}" title="Mankit: ${history[dateStr].mankit.type}">`;
                    }
                }

                calendarHtml += `<td>${day}<br>${poImg}${mankitImg}</td>`;

                if ((day + firstDay) % 7 === 0) {
                    calendarHtml += '</tr><tr>';
                }
            }

            calendarHtml += '</tr></table>';

            document.getElementById('calendarContainer').innerHTML = calendarHtml;
            document.getElementById('moodModal').style.display = 'block';
        }

        // ä¿®æ”¹ï¼šåŠ è½½ä»Šæ—¥å¿ƒæƒ…å¹¶å¼ºåˆ¶æ’­æ”¾åŠ¨ç”»
        function loadTodayMood() {
            const today = new Date().toDateString();
            
            // æ¢å¤Poçš„å¿ƒæƒ…
            const poMood = localStorage.getItem(`po_mood_${today}`);
            if (poMood) {
                const poImg = document.getElementById('po-mood');
                poImg.src = poMood + '?t=' + Date.now(); // æ·»åŠ æ—¶é—´æˆ³å¼ºåˆ¶é‡æ–°åŠ è½½
                // å¼ºåˆ¶é‡æ–°åŠ è½½ä»¥ç¡®ä¿åŠ¨ç”»æ’­æ”¾
                poImg.onload = function() {
                    this.style.animationPlayState = 'running';
                };
                // æ–°å¢ï¼šå‘¨æœŸé‡åŠ è½½ä»¥ä¿æŒåŠ¨ç”»ä¸€ç›´åŠ¨
                setInterval(() => {
                    const baseSrc = poImg.src.split('?')[0];
                    poImg.src = baseSrc + '?t=' + Date.now();
                }, 5000);
            }
            
            // æ¢å¤Mankitçš„å¿ƒæƒ…
            const mankitMood = localStorage.getItem(`mankit_mood_${today}`);
            if (mankitMood) {
                const mankitImg = document.getElementById('mankit-mood');
                mankitImg.src = mankitMood + '?t=' + Date.now(); // æ·»åŠ æ—¶é—´æˆ³å¼ºåˆ¶é‡æ–°åŠ è½½
                // å¼ºåˆ¶é‡æ–°åŠ è½½ä»¥ç¡®ä¿åŠ¨ç”»æ’­æ”¾
                mankitImg.onload = function() {
                    this.style.animationPlayState = 'running';
                };
                // æ–°å¢ï¼šå‘¨æœŸé‡åŠ è½½ä»¥ä¿æŒåŠ¨ç”»ä¸€ç›´åŠ¨
                setInterval(() => {
                    const baseSrc = mankitImg.src.split('?')[0];
                    mankitImg.src = baseSrc + '?t=' + Date.now();
                }, 5000);
            }
        }

        // ===== æ–°å¢ï¼šä»Šå¤©åƒä»€ä¹ˆåŠŸèƒ½å‡½æ•° =====
        function toggleFoodOptions() {
            const options = document.getElementById('food-options');
            options.classList.toggle('show');
        }

        function selectFood(foodType) {
            const foodOptions = {
                'ä¸­é¤': ['å®«ä¿é¸¡ä¸', 'çº¢çƒ§è‚‰', 'éº»å©†è±†è…', 'ç³–é†‹é‡Œè„Š', 'é±¼é¦™è‚‰ä¸', 'å›é”…è‚‰', 'æ°´ç…®é±¼', 'ç™½åˆ‡é¸¡'],
                'è¥¿é¤': ['ç‰›æ’', 'æ„å¤§åˆ©é¢', 'æŠ«è¨', 'æ±‰å ¡', 'æ²™æ‹‰', 'ç„—é¥­', 'æµ“æ±¤', 'çƒ¤é¸¡'],
                'æ—¥æ–™': ['å¯¿å¸', 'æ‹‰é¢', 'å¤©å¦‡ç½—', 'åˆºèº«', 'æ—¥å¼å’–å–±', 'é³—é±¼é¥­', 'å‘³å™Œæ±¤', 'é“æ¿çƒ§'],
                'éŸ©é¤': ['éŸ©å¼çƒ¤è‚‰', 'çŸ³é”…æ‹Œé¥­', 'æ³¡èœæ±¤', 'ç‚¸é¸¡', 'å†·é¢', 'è¾£ç‚’å¹´ç³•', 'éƒ¨é˜Ÿé”…', 'æµ·é²œé¥¼'],
                'ç«é”…': ['å››å·ç«é”…', 'æ¸…æ±¤ç«é”…', 'éº»è¾£çƒ«', 'å…³ä¸œç…®', 'æ¶®ç¾Šè‚‰', 'é…¸èœé±¼ç«é”…', 'ç•ªèŒ„ç«é”…'],
                'çƒ§çƒ¤': ['ç¾Šè‚‰ä¸²', 'çƒ¤é¸¡ç¿…', 'çƒ¤èŒ„å­', 'çƒ¤ç‰ç±³', 'çƒ¤é±¿é±¼', 'çƒ¤éŸ­èœ', 'çƒ¤åœŸè±†'],
                'å¿«é¤': ['è‚¯å¾·åŸº', 'éº¦å½“åŠ³', 'æ±‰å ¡ç‹', 'Subway', 'å¿…èƒœå®¢', 'åè±å£«', 'å¾·å…‹å£«'],
                'ç”œå“': ['è›‹ç³•', 'å†°æ·‡æ·‹', 'å¸ƒä¸', 'é©¬å¡é¾™', 'æ³¡èŠ™', 'ææ‹‰ç±³è‹', 'æ…•æ–¯', 'èŠå£«è›‹ç³•'],
                'å¤–å–': ['ç¾å›¢å¤–å–æ¨è', 'é¥¿äº†ä¹ˆä»Šæ—¥ç‰¹ä»·', 'éšæœºå¤–å–æ¢ç´¢', 'é™„è¿‘çƒ­é—¨é¤å…'],
                'éšæœº': []
            };

            let selectedFood;
            if (foodType === 'éšæœº') {
                const allFoods = Object.values(foodOptions).flat().filter(food => food);
                selectedFood = allFoods[Math.floor(Math.random() * allFoods.length)];
            } else {
                const foods = foodOptions[foodType];
                selectedFood = foods[Math.floor(Math.random() * foods.length)];
            }

            document.getElementById('food-display').innerHTML = `ğŸ‰ ä»Šå¤©åƒ: <br><strong>${selectedFood}</strong>`;
            document.getElementById('food-options').classList.remove('show');
            
            // ä¿å­˜é€‰æ‹©
            const today = new Date().toDateString();
            localStorage.setItem(`food_choice_${today}`, selectedFood);
        }

        function loadTodayFood() {
            const today = new Date().toDateString();
            const foodChoice = localStorage.getItem(`food_choice_${today}`);
            if (foodChoice) {
                document.getElementById('food-display').innerHTML = `ğŸ‰ ä»Šå¤©åƒ: <br><strong>${foodChoice}</strong>`;
            }
        }

        // é”®ç›˜äº‹ä»¶ç›‘å¬
        document.addEventListener('DOMContentLoaded', function() {
            // ç™»å½•å›è½¦äº‹ä»¶
            const passwordInput = document.getElementById('password');
            if (passwordInput) {
                passwordInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        login();
                    }
                });
            }

            // æ¶ˆæ¯å‘é€å›è½¦äº‹ä»¶
            const messageInput = document.getElementById('messageInput');
            if (messageInput) {
                messageInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
            }

            // ===== æ–°å¢ï¼šç‚¹å‡»å¤–éƒ¨å…³é—­é¢æ¿ =====
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.mood-module')) {
                    document.getElementById('mood-selector').classList.remove('show');
                }
                if (!e.target.closest('.food-module')) {
                    document.getElementById('food-options').classList.remove('show');
                }
                // æ–°å¢ï¼šç‚¹å‡»å¤–éƒ¨å…³é—­è¡¨æƒ…é¢æ¿
                if (!e.target.closest('.emoji-btn') && !e.target.closest('.emoji-panel')) {
                    document.getElementById('emoji-panel').classList.remove('show');
                }
            });
        });
    </script>
</body>
</html> 



