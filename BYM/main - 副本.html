<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®å§¨éº»ä¹‹å®¶</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #ffc0cb 0%, #e0f6ff 50%, #ffffff 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ç™»å½•åçš„èƒŒæ™¯ - èåˆåŸèƒŒæ™¯è‰²å’Œå›¾ç‰‡ */
        body.logged-in {
            background: 
                linear-gradient(135deg, rgba(255, 192, 203, 0.7) 0%, rgba(224, 246, 255, 0.7) 50%, rgba(255, 255, 255, 0.7) 100%),
                url('./mbg.jpg');
            background-size: cover, cover;
            background-position: center, center;
            background-repeat: no-repeat, no-repeat;
            background-attachment: fixed, fixed;
        }

        .container {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 40px;
            width: 90%;
            max-width: 800px;
            backdrop-filter: blur(10px);
        }

        /* ç™»å½•åå®¹å™¨èƒŒæ™¯è°ƒæ•´ */
        body.logged-in .container {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(15px);
        }

        .login-container {
            text-align: center;
            background-image: url('./bg.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            border-radius: 20px;
            padding: 40px;
            position: relative;
        }

        .login-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.85);
            border-radius: 20px;
            z-index: 1;
        }

        .login-container > * {
            position: relative;
            z-index: 2;
        }

        .main-container {
            display: none;
        }

        .history-container {
            display: none;
        }

        h1 {
            color: #ff69b4;
            margin-bottom: 30px;
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
            max-width: 300px;
            margin: 0 auto;
        }

        .login-form input {
            padding: 15px;
            border: 2px solid #ffc0cb;
            border-radius: 10px;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.9);
            transition: all 0.3s ease;
        }

        .login-form input:focus {
            outline: none;
            border-color: #87ceeb;
            box-shadow: 0 0 10px rgba(135, 206, 235, 0.3);
        }

        .login-btn {
            background: linear-gradient(45deg, #ffc0cb, #87ceeb);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .login-btn:hover {
            transform: translateY(-2px);
        }

        .user-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding: 20px;
            background: rgba(255, 192, 203, 0.2);
            border-radius: 15px;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
        }

        .nav-btn, .logout-btn {
            background: #ff69b4;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s ease;
            font-size: 14px;
        }

        .nav-btn:hover, .logout-btn:hover {
            background: #ff1493;
        }

        .nav-btn.active {
            background: #87ceeb;
        }

        .nav-btn.active:hover {
            background: #4682b4;
        }

        .avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid #fff;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            background-color: #fff;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        .mankit-avatar {
            background-image: url('./manicon.png');
        }

        .po-avatar {
            background-image: url('./poicon.png');
        }

        .message-form {
            margin-bottom: 25px;
            padding: 25px;
            background: rgba(135, 206, 235, 0.1);
            border-radius: 15px;
        }

        .message-input {
            width: 100%;
            min-height: 120px;
            padding: 15px;
            border: 2px solid #87ceeb;
            border-radius: 10px;
            font-size: 16px;
            resize: vertical;
            background: rgba(255, 255, 255, 0.9);
            margin-bottom: 15px;
        }

        .send-btn {
            background: linear-gradient(45deg, #87ceeb, #ffc0cb);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .send-btn:hover {
            transform: translateY(-2px);
        }

        .messages {
            max-height: 400px;
            overflow-y: auto;
            padding: 20px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 15px;
        }

        .week-info {
            text-align: center;
            margin-bottom: 15px;
            padding: 10px 15px;
            background: rgba(255, 182, 193, 0.3);
            border-radius: 10px;
            color: #666;
            font-size: 14px;
        }

        .message {
            margin-bottom: 20px;
            padding: 20px;
            border-radius: 15px;
            animation: fadeIn 0.5s ease-in;
        }

        .message.po {
            background: rgba(255, 192, 203, 0.3);
            margin-right: 20px;
        }

        .message.mankit {
            background: rgba(135, 206, 235, 0.3);
            margin-left: 20px;
        }

        .message-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            gap: 10px;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #fff;
            background-color: #fff;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        .message-user {
            font-weight: bold;
            color: #333;
        }

        .message-time {
            color: #666;
            font-size: 12px;
            margin-left: auto;
        }

        .message-content {
            color: #444;
            line-height: 1.5;
            word-wrap: break-word;
        }

        .error {
            color: #ff4444;
            text-align: center;
            margin-top: 10px;
        }

        /* å†å²æ¶ˆæ¯æ ·å¼ */
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 20px;
            background: rgba(135, 206, 235, 0.2);
            border-radius: 15px;
        }

        .back-btn {
            background: #87ceeb;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .back-btn:hover {
            background: #4682b4;
        }

        .history-stats {
            color: #666;
            font-size: 14px;
        }

        .week-section {
            margin-bottom: 30px;
            border: 2px solid rgba(255, 182, 193, 0.3);
            border-radius: 15px;
            overflow: hidden;
        }

        .week-header {
            background: rgba(255, 182, 193, 0.3);
            padding: 15px 20px;
            font-weight: bold;
            color: #666;
            cursor: pointer;
            transition: background 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .week-header:hover {
            background: rgba(255, 182, 193, 0.5);
        }

        .week-header.expanded {
            background: rgba(255, 182, 193, 0.6);
        }

        .week-messages {
            display: none;
            padding: 20px;
            background: rgba(255, 255, 255, 0.3);
            max-height: 300px;
            overflow-y: auto;
        }

        .week-messages.expanded {
            display: block;
        }

        .expand-icon {
            transition: transform 0.3s ease;
        }

        .expand-icon.expanded {
            transform: rotate(90deg);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 20px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .user-info {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .nav-buttons {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .message.po {
                margin-right: 0;
            }
            
            .message.mankit {
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ç™»å½•ç•Œé¢ -->
        <div class="login-container" id="loginContainer">
            <h1>ğŸ’• å®å§¨éº»ä¹‹å®¶ ğŸ’•</h1>
            <div class="login-form">
                <input type="text" id="username" placeholder="ç”¨æˆ·å" />
                <input type="password" id="password" placeholder="å¯†ç " />
                <button class="login-btn" onclick="login()">ç™»å½•</button>
                <div class="error" id="loginError"></div>
            </div>
        </div>

        <!-- ä¸»ç•Œé¢ -->
        <div class="main-container" id="mainContainer">
            <div class="user-info">
                <div class="user-profile">
                    <div class="avatar" id="userAvatar"></div>
                    <div>
                        <div>æ¬¢è¿å›æ¥ï¼Œ<span id="currentUser"></span> â¤ï¸</div>
                    </div>
                </div>
                <div class="nav-buttons">
                    <button class="nav-btn active" id="currentBtn" onclick="showCurrent()">æœ¬å‘¨å¯¹è¯</button>
                    <button class="nav-btn" id="historyBtn" onclick="showHistory()">å†å²è®°å½•</button>
                    <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
                </div>
            </div>

            <div class="week-info" id="weekInfo"></div>

            <div class="message-form">
                <textarea class="message-input" id="messageInput" placeholder="å†™ä¸‹ä½ æƒ³è¯´çš„è¯..."></textarea>
                <button class="send-btn" onclick="sendMessage()">å‘é€æ¶ˆæ¯ ğŸ’Œ</button>
            </div>

            <div class="messages" id="messages"></div>
        </div>

        <!-- å†å²æ¶ˆæ¯ç•Œé¢ -->
        <div class="history-container" id="historyContainer">
            <div class="history-header">
                <button class="back-btn" onclick="showCurrent()">â† è¿”å›å½“å‰å¯¹è¯</button>
                <h2 style="color: #ff69b4; margin: 0;">å†å²è®°å½• ğŸ“š</h2>
                <div class="history-stats" id="historyStats"></div>
            </div>
            
            <div id="historyContent"></div>
        </div>
    </div>

    <script>
        // ç”¨æˆ·æ•°æ®
        const users = {
            'po': {
                password: '0526',
                avatar: 'po-avatar',
                name: 'Po'
            },
            'mankit': {
                password: '1117',
                avatar: 'mankit-avatar',
                name: 'Mankit'
            }
        };

        // å…¨å±€å˜é‡åˆå§‹åŒ–
        let currentUser = null;
        let allMessages = [];

        // è·å–å½“å‰å‘¨çš„å¼€å§‹å’Œç»“æŸæ—¶é—´
        function getCurrentWeekRange() {
            const now = new Date();
            const dayOfWeek = now.getDay();
            const startOfWeek = new Date(now);
            startOfWeek.setDate(now.getDate() - dayOfWeek);
            startOfWeek.setHours(0, 0, 0, 0);
            
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            endOfWeek.setHours(23, 59, 59, 999);
            
            return { start: startOfWeek, end: endOfWeek };
        }

        // è·å–æŸä¸ªæ—¥æœŸæ‰€åœ¨å‘¨çš„èŒƒå›´
        function getWeekRange(date) {
            const dayOfWeek = date.getDay();
            const startOfWeek = new Date(date);
            startOfWeek.setDate(date.getDate() - dayOfWeek);
            startOfWeek.setHours(0, 0, 0, 0);
            
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            endOfWeek.setHours(23, 59, 59, 999);
            
            return { start: startOfWeek, end: endOfWeek };
        }

        // æ ¼å¼åŒ–å‘¨èŒƒå›´æ˜¾ç¤º
        function formatWeekRange(start, end) {
            const options = { month: 'short', day: 'numeric' };
            return `${start.toLocaleDateString('zh-CN', options)} - ${end.toLocaleDateString('zh-CN', options)}`;
        }

        // æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦åœ¨å½“å‰å‘¨
        function isCurrentWeek(messageDate) {
            const currentWeek = getCurrentWeekRange();
            return messageDate >= currentWeek.start && messageDate <= currentWeek.end;
        }

        // è·å–å½“å‰å‘¨æ¶ˆæ¯
        function getCurrentWeekMessages() {
            return allMessages.filter(msg => isCurrentWeek(new Date(msg.timestamp)));
        }

        // è·å–å†å²æ¶ˆæ¯ï¼ˆæŒ‰å‘¨åˆ†ç»„ï¼‰
        function getHistoryMessages() {
            const historyMessages = allMessages.filter(msg => !isCurrentWeek(new Date(msg.timestamp)));
            const messagesByWeek = {};
            
            historyMessages.forEach(msg => {
                const msgDate = new Date(msg.timestamp);
                const weekRange = getWeekRange(msgDate);
                const weekKey = `${weekRange.start.getTime()}-${weekRange.end.getTime()}`;
                
                if (!messagesByWeek[weekKey]) {
                    messagesByWeek[weekKey] = {
                        start: weekRange.start,
                        end: weekRange.end,
                        messages: []
                    };
                }
                
                messagesByWeek[weekKey].messages.push(msg);
            });
            
            // æŒ‰æ—¶é—´å€’åºæ’åˆ—ï¼ˆæœ€æ–°çš„å‘¨åœ¨å‰é¢ï¼‰
            return Object.values(messagesByWeek).sort((a, b) => b.start.getTime() - a.start.getTime());
        }

        // å®‰å…¨çš„localStorageæ“ä½œ
        function saveMessages() {
            try {
                localStorage.setItem('coupleMessages', JSON.stringify(allMessages));
            } catch (e) {
                console.log('æ— æ³•ä¿å­˜åˆ°localStorageï¼Œä½¿ç”¨å†…å­˜å­˜å‚¨');
            }
        }

        function loadMessages() {
            try {
                const saved = localStorage.getItem('coupleMessages');
                if (saved) {
                    allMessages = JSON.parse(saved);
                    // ç¡®ä¿æ‰€æœ‰æ¶ˆæ¯éƒ½æœ‰æœ‰æ•ˆçš„æ—¶é—´æˆ³
                    allMessages.forEach(msg => {
                        if (typeof msg.timestamp === 'string' && !msg.timestamp.includes('T')) {
                            // è½¬æ¢æ—§æ ¼å¼çš„æ—¶é—´æˆ³
                            msg.timestamp = new Date(msg.timestamp).toISOString();
                        }
                    });
                }
            } catch (e) {
                console.log('æ— æ³•ä»localStorageè¯»å–ï¼Œä½¿ç”¨ç©ºæ•°ç»„');
                allMessages = [];
            }
        }

        // åˆå§‹åŒ–åº”ç”¨
        function initApp() {
            loadMessages();
            updateWeekInfo();
            displayCurrentMessages();
        }

        // æ›´æ–°å‘¨ä¿¡æ¯
        function updateWeekInfo() {
            const weekInfo = document.getElementById('weekInfo');
            const currentWeek = getCurrentWeekRange();
            const currentMessages = getCurrentWeekMessages();
            
            weekInfo.innerHTML = `
                ğŸ“… æœ¬å‘¨å¯¹è¯ (${formatWeekRange(currentWeek.start, currentWeek.end)}) 
                <br>å…± ${currentMessages.length} æ¡æ¶ˆæ¯
            `;
        }

        // æ˜¾ç¤ºå½“å‰å‘¨æ¶ˆæ¯
        function showCurrent() {
            document.getElementById('mainContainer').style.display = 'block';
            document.getElementById('historyContainer').style.display = 'none';
            document.getElementById('currentBtn').classList.add('active');
            document.getElementById('historyBtn').classList.remove('active');
            displayCurrentMessages();
        }

        // æ˜¾ç¤ºå†å²è®°å½•
        function showHistory() {
            document.getElementById('mainContainer').style.display = 'none';
            document.getElementById('historyContainer').style.display = 'block';
            document.getElementById('currentBtn').classList.remove('active');
            document.getElementById('historyBtn').classList.add('active');
            displayHistoryMessages();
        }

        // ç™»å½•åŠŸèƒ½
        function login() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('loginError');

            if (!username || !password) {
                errorDiv.textContent = 'è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ';
                return;
            }

            if (users[username] && users[username].password === password) {
                currentUser = username;
                showMainInterface();
                errorDiv.textContent = '';
            } else {
                errorDiv.textContent = 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯';
            }
        }

        // æ˜¾ç¤ºä¸»ç•Œé¢
        function showMainInterface() {
            // æ·»åŠ ç™»å½•åçš„èƒŒæ™¯æ ·å¼
            document.body.classList.add('logged-in');
            
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('mainContainer').style.display = 'block';
            
            const userAvatar = document.getElementById('userAvatar');
            const currentUserSpan = document.getElementById('currentUser');
            
            userAvatar.className = `avatar ${users[currentUser].avatar}`;
            currentUserSpan.textContent = users[currentUser].name;
            
            initApp();
        }

        // é€€å‡ºç™»å½•
        function logout() {
            // ç§»é™¤ç™»å½•åçš„èƒŒæ™¯æ ·å¼
            document.body.classList.remove('logged-in');
            
            currentUser = null;
            document.getElementById('loginContainer').style.display = 'block';
            document.getElementById('mainContainer').style.display = 'none';
            document.getElementById('historyContainer').style.display = 'none';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('loginError').textContent = '';
        }

        // å‘é€æ¶ˆæ¯
        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const content = messageInput.value.trim();

            if (!content) {
                alert('è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹');
                return;
            }

            const message = {
                user: currentUser,
                content: content,
                timestamp: new Date().toISOString()
            };

            allMessages.push(message);
            saveMessages();
            messageInput.value = '';
            updateWeekInfo();
            displayCurrentMessages();
        }

        // æ˜¾ç¤ºå½“å‰å‘¨æ¶ˆæ¯
        function displayCurrentMessages() {
            const messagesContainer = document.getElementById('messages');
            if (!messagesContainer) return;
            
            const currentMessages = getCurrentWeekMessages();
            messagesContainer.innerHTML = '';

            if (currentMessages.length === 0) {
                messagesContainer.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">æœ¬å‘¨è¿˜æ²¡æœ‰æ¶ˆæ¯ï¼Œå¿«æ¥å‘è¡¨ç¬¬ä¸€æ¡ç•™è¨€å§ï¼ğŸ’</div>';
                return;
            }

            currentMessages.forEach(message => {
                const messageDiv = createMessageElement(message);
                messagesContainer.appendChild(messageDiv);
            });

            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // æ˜¾ç¤ºå†å²æ¶ˆæ¯
        function displayHistoryMessages() {
            const historyContent = document.getElementById('historyContent');
            const historyStats = document.getElementById('historyStats');
            const historyData = getHistoryMessages();
            
            historyContent.innerHTML = '';
            
            if (historyData.length === 0) {
                historyContent.innerHTML = '<div style="text-align: center; color: #999; padding: 40px;">è¿˜æ²¡æœ‰å†å²è®°å½• ğŸ“­</div>';
                historyStats.textContent = 'æ€»è®¡: 0 æ¡å†å²æ¶ˆæ¯';
                return;
            }

            const totalHistoryMessages = historyData.reduce((sum, week) => sum + week.messages.length, 0);
            historyStats.textContent = `æ€»è®¡: ${totalHistoryMessages} æ¡å†å²æ¶ˆæ¯ï¼Œ${historyData.length} å‘¨`;

            historyData.forEach((weekData, index) => {
                const weekSection = document.createElement('div');
                weekSection.className = 'week-section';
                
                const weekHeader = document.createElement('div');
                weekHeader.className = 'week-header';
                weekHeader.innerHTML = `
                    <span>ğŸ“… ${formatWeekRange(weekData.start, weekData.end)} (${weekData.messages.length} æ¡æ¶ˆæ¯)</span>
                    <span class="expand-icon">â–¶</span>
                `;
                
                const weekMessages = document.createElement('div');
                weekMessages.className = 'week-messages';
                
                weekData.messages.forEach(message => {
                    const messageDiv = createMessageElement(message);
                    weekMessages.appendChild(messageDiv);
                });
                
                weekHeader.onclick = function() {
                    const isExpanded = weekMessages.classList.contains('expanded');
                    weekMessages.classList.toggle('expanded');
                    weekHeader.classList.toggle('expanded');
                    const icon = weekHeader.querySelector('.expand-icon');
                    icon.classList.toggle('expanded');
                };
                
                weekSection.appendChild(weekHeader);
                weekSection.appendChild(weekMessages);
                historyContent.appendChild(weekSection);
            });
        }

        // åˆ›å»ºæ¶ˆæ¯å…ƒç´ 
        function createMessageElement(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${message.user}`;
            
            const messageTime = new Date(message.timestamp).toLocaleString('zh-CN');
            
            messageDiv.innerHTML = `
                <div class="message-header">
                    <div class="message-avatar ${users[message.user].avatar}"></div>
                    <span class="message-user">${users[message.user].name}</span>
                    <span class="message-time">${messageTime}</span>
                </div>
                <div class="message-content">${message.content}</div>
            `;
            
            return messageDiv;
        }

        // é”®ç›˜äº‹ä»¶ç›‘å¬
        document.addEventListener('DOMContentLoaded', function() {
            // ç™»å½•å›è½¦äº‹ä»¶
            const passwordInput = document.getElementById('password');
            if (passwordInput) {
                passwordInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        login();
                    }
                });
            }

            // æ¶ˆæ¯å‘é€å›è½¦äº‹ä»¶
            const messageInput = document.getElementById('messageInput');
            if (messageInput) {
                messageInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
            }
        });
    </script>
</body>
</html>