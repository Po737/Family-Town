<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>宝姨麻之家</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #ffc0cb 0%, #e0f6ff 50%, #ffffff 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* 登录后的背景 - 融合原背景色和图片 */
        body.logged-in {
            background: 
                linear-gradient(135deg, rgba(255, 192, 203, 0.7) 0%, rgba(224, 246, 255, 0.7) 50%, rgba(255, 255, 255, 0.7) 100%),
                url('./mbg.jpg');
            background-size: cover, cover;
            background-position: center, center;
            background-repeat: no-repeat, no-repeat;
            background-attachment: fixed, fixed;
        }

        .container {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 40px;
            width: 90%;
            max-width: 800px;
            backdrop-filter: blur(10px);
        }

        /* 登录后容器背景调整 */
        body.logged-in .container {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(15px);
        }

        .login-container {
            text-align: center;
            background-image: url('./bg.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            border-radius: 20px;
            padding: 40px;
            position: relative;
        }

        .login-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.85);
            border-radius: 20px;
            z-index: 1;
        }

        .login-container > * {
            position: relative;
            z-index: 2;
        }

        .main-container {
            display: none;
        }

        .history-container {
            display: none;
        }

        h1 {
            color: #ff69b4;
            margin-bottom: 30px;
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
            max-width: 300px;
            margin: 0 auto;
        }

        .login-form input {
            padding: 15px;
            border: 2px solid #ffc0cb;
            border-radius: 10px;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.9);
            transition: all 0.3s ease;
        }

        .login-form input:focus {
            outline: none;
            border-color: #87ceeb;
            box-shadow: 0 0 10px rgba(135, 206, 235, 0.3);
        }

        .login-btn {
            background: linear-gradient(45deg, #ffc0cb, #87ceeb);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .login-btn:hover {
            transform: translateY(-2px);
        }

        .user-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding: 20px;
            background: rgba(255, 192, 203, 0.2);
            border-radius: 15px;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
        }

        .nav-btn, .logout-btn {
            background: #ff69b4;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s ease;
            font-size: 14px;
        }

        .nav-btn:hover, .logout-btn:hover {
            background: #ff1493;
        }

        .nav-btn.active {
            background: #87ceeb;
        }

        .nav-btn.active:hover {
            background: #4682b4;
        }

        .avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid #fff;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            background-color: #fff;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        .mankit-avatar {
            background-image: url('./manicon.png');
        }

        .po-avatar {
            background-image: url('./poicon.png');
        }

        .message-form {
            margin-bottom: 25px;
            padding: 25px;
            background: rgba(135, 206, 235, 0.1);
            border-radius: 15px;
        }

        .message-input {
            width: 100%;
            min-height: 120px;
            padding: 15px;
            border: 2px solid #87ceeb;
            border-radius: 10px;
            font-size: 16px;
            resize: vertical;
            background: rgba(255, 255, 255, 0.9);
            margin-bottom: 15px;
        }

        .send-btn {
            background: linear-gradient(45deg, #87ceeb, #ffc0cb);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .send-btn:hover {
            transform: translateY(-2px);
        }

        .messages {
            max-height: 400px;
            overflow-y: auto;
            padding: 20px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 15px;
        }

        .week-info {
            text-align: center;
            margin-bottom: 15px;
            padding: 10px 15px;
            background: rgba(255, 182, 193, 0.3);
            border-radius: 10px;
            color: #666;
            font-size: 14px;
        }

        .message {
            margin-bottom: 20px;
            padding: 20px;
            border-radius: 15px;
            animation: fadeIn 0.5s ease-in;
        }

        .message.po {
            background: rgba(255, 192, 203, 0.3);
            margin-right: 20px;
        }

        .message.mankit {
            background: rgba(135, 206, 235, 0.3);
            margin-left: 20px;
        }

        .message-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            gap: 10px;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #fff;
            background-color: #fff;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        .message-user {
            font-weight: bold;
            color: #333;
        }

        .message-time {
            color: #666;
            font-size: 12px;
            margin-left: auto;
        }

        .message-content {
            color: #444;
            line-height: 1.5;
            word-wrap: break-word;
        }

        .error {
            color: #ff4444;
            text-align: center;
            margin-top: 10px;
        }

        /* 历史消息样式 */
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 20px;
            background: rgba(135, 206, 235, 0.2);
            border-radius: 15px;
        }

        .back-btn {
            background: #87ceeb;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .back-btn:hover {
            background: #4682b4;
        }

        .history-stats {
            color: #666;
            font-size: 14px;
        }

        .week-section {
            margin-bottom: 30px;
            border: 2px solid rgba(255, 182, 193, 0.3);
            border-radius: 15px;
            overflow: hidden;
        }

        .week-header {
            background: rgba(255, 182, 193, 0.3);
            padding: 15px 20px;
            font-weight: bold;
            color: #666;
            cursor: pointer;
            transition: background 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .week-header:hover {
            background: rgba(255, 182, 193, 0.5);
        }

        .week-header.expanded {
            background: rgba(255, 182, 193, 0.6);
        }

        .week-messages {
            display: none;
            padding: 20px;
            background: rgba(255, 255, 255, 0.3);
            max-height: 300px;
            overflow-y: auto;
        }

        .week-messages.expanded {
            display: block;
        }

        .expand-icon {
            transition: transform 0.3s ease;
        }

        .expand-icon.expanded {
            transform: rotate(90deg);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ===== 新增：左侧面板样式 ===== */
        .left-sidebar {
            display: none; /* 登录前隐藏 */
            position: fixed;
            left: 20px;
            top: 20px;
            width: 280px;
            height: calc(100vh - 40px);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            overflow-y: auto;
        }

        body.logged-in .left-sidebar {
            display: block;
        }

        /* 缩短距离，让主界面更居中 */
        body.logged-in .container {
            margin-left: 250px;
        }

        /* Daily Mood 模块 */
        .mood-module {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            border-radius: 15px;
            padding: 15px; /* 修改：减少padding */
            margin-bottom: 20px;
            color: white;
            box-shadow: 0 8px 25px rgba(255, 154, 158, 0.3);
        }

        .mood-header {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px; /* 修改：减少margin */
            cursor: pointer;
            padding: 8px; /* 修改：减少padding */
            border-radius: 10px;
            transition: all 0.3s;
            user-select: none;
        }

        .mood-header:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        /* 修改：减少margin以增加显示空间 */
        .mood-display {
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin-bottom: 8px; /* 修改：进一步减少margin */
            padding: 8px; /* 修改：减少padding */
            background: rgba(255, 255, 255, 0.2);
            border-radius: 12px;
        }

        .user-mood-display {
            text-align: center;
            flex: 1;
        }

        .user-mood-label {
            font-size: 12px;
            margin-bottom: 5px; /* 修改：减少margin */
            opacity: 0.9;
            font-weight: bold;
        }

        /* 修改：确保GIF可以动态显示并强制循环播放 */
        .mood-gif {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid rgba(255, 255, 255, 0.6);
            transition: all 0.3s;
            cursor: pointer;
            background: white;
            /* 确保GIF可以正常循环播放 */
            image-rendering: auto;
            animation-iteration-count: infinite;
        }

        .mood-gif:hover {
            transform: scale(1.1);
            border-color: rgba(255, 255, 255, 0.9);
        }

        /* 修改：只有当前用户可以点击自己的头像 */
        .mood-gif.clickable {
            cursor: pointer;
        }

        /* 删除disabled样式，移除透明遮蔽 */

        /* 修改：4*3布局，无需滚动 */
        .mood-selector {
            display: none;
            grid-template-columns: repeat(4, 1fr); /* 修改：4列布局 */
            gap: 6px; /* 修改：减少间距 */
            margin-top: 8px; /* 修改：减少margin */
            padding: 8px; /* 修改：减少padding */
            background: rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            max-height: none; /* 修改：移除滚动限制 */
            overflow: visible; /* 修改：移除滚动 */
        }

        .mood-selector.show {
            display: grid;
        }

        /* 修改：缩小emoji按钮 */
        .mood-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 6px 3px; /* 修改：减少padding */
            border-radius: 8px; /* 修改：缩小圆角 */
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(255, 255, 255, 0.1);
        }

        .mood-option:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px); /* 修改：减少移动距离 */
        }

        .mood-option .emoji {
            font-size: 20px; /* 修改：缩小emoji */
            margin-bottom: 3px; /* 修改：减少margin */
        }

        .mood-option span {
            font-size: 8px; /* 修改：缩小字体 */
            text-align: center;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        .mood-history-btn {
            background: rgba(255, 255, 255, 0.25);
            border: none;
            color: white;
            padding: 6px 12px; /* 修改：减少padding */
            border-radius: 20px;
            cursor: pointer;
            font-size: 11px; /* 修改：缩小字体 */
            margin-top: 6px; /* 修改：减少margin */
            width: 100%;
            transition: all 0.3s;
            font-weight: bold;
        }

        .mood-history-btn:hover {
            background: rgba(255, 255, 255, 0.4);
            transform: translateY(-2px);
        }

        /* 今天吃什么模块 */
        .food-module {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            border-radius: 15px;
            padding: 20px;
            color: #333;
            box-shadow: 0 8px 25px rgba(168, 237, 234, 0.3);
        }

        .food-header {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            cursor: pointer;
            padding: 10px;
            border-radius: 10px;
            transition: all 0.3s;
            user-select: none;
            color: #444;
        }

        .food-header:hover {
            background: rgba(255, 255, 255, 0.4);
            transform: translateY(-2px);
        }

        .food-display {
            text-align: center;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 15px;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.4);
            border-radius: 12px;
            padding: 15px;
            color: #555;
            border: 2px dashed rgba(255, 255, 255, 0.6);
        }

        .food-options {
            display: none;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 15px;
        }

        .food-options.show {
            display: grid;
        }

        .food-option {
            padding: 12px 8px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            font-size: 13px;
            font-weight: bold;
            color: #555;
            border: 1px solid rgba(255, 255, 255, 0.4);
        }

        .food-option:hover {
            background: rgba(255, 255, 255, 0.6);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 20px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .user-info {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .nav-buttons {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .message.po {
                margin-right: 0;
            }
            
            .message.mankit {
                margin-left: 0;
            }

            /* 移动端隐藏左侧面板或调整布局 */
            .left-sidebar {
                display: none !important;
            }

            body.logged-in .container {
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <!-- ===== 新增：左侧面板 ===== -->
    <div class="left-sidebar" id="leftSidebar">
        <!-- Daily Mood 模块 -->
        <div class="mood-module">
            <div class="mood-header" onclick="toggleMoodSelector()">
                🌈 Daily Mood
            </div>
            
            <!-- 当前心情显示 -->
            <div class="mood-display">
                <div class="user-mood-display">
                    <div class="user-mood-label">Po</div>
                    <img id="po-mood" class="mood-gif" src="dailyemo/normal.gif" alt="Po's mood" onclick="setCurrentUser('po')">
                </div>
                <div class="user-mood-display">
                    <div class="user-mood-label">Mankit</div>
                    <img id="mankit-mood" class="mood-gif" src="dailyemo/normal.gif" alt="Mankit's mood" onclick="setCurrentUser('mankit')">
                </div>
            </div>
            
            <!-- 心情选择器 - 4*3布局 -->
            <div id="mood-selector" class="mood-selector">
                <div class="mood-option" onclick="selectMood('angry')">
                    <div class="emoji">😠</div>
                    <span>生气</span>
                </div>
                <div class="mood-option" onclick="selectMood('hateu')">
                    <div class="emoji">😤</div>
                    <span>讨厌你</span>
                </div>
                <div class="mood-option" onclick="selectMood('sad')">
                    <div class="emoji">😢</div>
                    <span>难过</span>
                </div>
                <div class="mood-option" onclick="selectMood('happy')">
                    <div class="emoji">😊</div>
                    <span>开心</span>
                </div>
                <div class="mood-option" onclick="selectMood('proud')">
                    <div class="emoji">😎</div>
                    <span>得意</span>
                </div>
                <div class="mood-option" onclick="selectMood('normal')">
                    <div class="emoji">😐</div>
                    <span>平常</span>
                </div>
                <div class="mood-option" onclick="selectMood('loveu')">
                    <div class="emoji">😍</div>
                    <span>爱你</span>
                </div>
                <div class="mood-option" onclick="selectMood('sleepy')">
                    <div class="emoji">😴</div>
                    <span>困困</span>
                </div>
                <div class="mood-option" onclick="selectMood('weak')">
                    <div class="emoji">🤒</div>
                    <span>虚弱</span>
                </div>
                <div class="mood-option" onclick="selectMood('hardwork')">
                    <div class="emoji">💪</div>
                    <span>工作</span>
                </div>
            </div>
            
            <button class="mood-history-btn" onclick="showMoodHistory()">📊 心情历史</button>
        </div>

        <!-- 今天吃什么模块 -->
        <div class="food-module">
            <div class="food-header" onclick="toggleFoodOptions()">
                🍽️ 今天吃什么
            </div>
            
            <div id="food-display" class="food-display">
                点击上方开始选择美食！ 🎯
            </div>
            
            <div id="food-options" class="food-options">
                <div class="food-option" onclick="selectFood('中餐')">🥢 中餐</div>
                <div class="food-option" onclick="selectFood('西餐')">🍝 西餐</div>
                <div class="food-option" onclick="selectFood('日料')">🍣 日料</div>
                <div class="food-option" onclick="selectFood('韩餐')">🍜 韩餐</div>
                <div class="food-option" onclick="selectFood('火锅')">🍲 火锅</div>
                <div class="food-option" onclick="selectFood('烧烤')">🍖 烧烤</div>
                <div class="food-option" onclick="selectFood('快餐')">🍔 快餐</div>
                <div class="food-option" onclick="selectFood('甜品')">🍰 甜品</div>
                <div class="food-option" onclick="selectFood('随机')">🎲 随机</div>
                <div class="food-option" onclick="selectFood('外卖')">📱 外卖</div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- 登录界面 -->
        <div class="login-container" id="loginContainer">
            <h1>💕 宝姨麻之家 💕</h1>
            <div class="login-form">
                <input type="text" id="username" placeholder="用户名" />
                <input type="password" id="password" placeholder="密码" />
                <button class="login-btn" onclick="login()">登录</button>
                <div class="error" id="loginError"></div>
            </div>
        </div>

        <!-- 主界面 -->
        <div class="main-container" id="mainContainer">
            <div class="user-info">
                <div class="user-profile">
                    <div class="avatar" id="userAvatar"></div>
                    <div>
                        <div>欢迎回来，<span id="currentUser"></span> ❤️</div>
                    </div>
                </div>
                <div class="nav-buttons">
                    <button class="nav-btn active" id="currentBtn" onclick="showCurrent()">本周对话</button>
                    <button class="nav-btn" id="historyBtn" onclick="showHistory()">历史记录</button>
                    <button class="logout-btn" onclick="logout()">退出登录</button>
                </div>
            </div>

            <div class="week-info" id="weekInfo"></div>

            <div class="message-form">
                <textarea class="message-input" id="messageInput" placeholder="写下你想说的话..."></textarea>
                <button class="send-btn" onclick="sendMessage()">发送消息 💌</button>
            </div>

            <div class="messages" id="messages"></div>
        </div>

        <!-- 历史消息界面 -->
        <div class="history-container" id="historyContainer">
            <div class="history-header">
                <button class="back-btn" onclick="showCurrent()">← 返回当前对话</button>
                <h2 style="color: #ff69b4; margin: 0;">历史记录 📚</h2>
                <div class="history-stats" id="historyStats"></div>
            </div>
            
            <div id="historyContent"></div>
        </div>
    </div>

    <script>
        // 用户数据
        const users = {
            'po': {
                password: '0526',
                avatar: 'po-avatar',
                name: 'Po'
            },
            'mankit': {
                password: '1117',
                avatar: 'mankit-avatar',
                name: 'Mankit'
            }
        };

        // 全局变量初始化
        let currentUser = null;
        let allMessages = [];

        // ===== 新增：心情和食物功能变量 =====
        let moodCurrentUser = 'po'; // 当前要设置心情的用户

        // 获取当前周的开始和结束时间
        function getCurrentWeekRange() {
            const now = new Date();
            const dayOfWeek = now.getDay();
            const startOfWeek = new Date(now);
            startOfWeek.setDate(now.getDate() - dayOfWeek);
            startOfWeek.setHours(0, 0, 0, 0);
            
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            endOfWeek.setHours(23, 59, 59, 999);
            
            return { start: startOfWeek, end: endOfWeek };
        }

        // 获取某个日期所在周的范围
        function getWeekRange(date) {
            const dayOfWeek = date.getDay();
            const startOfWeek = new Date(date);
            startOfWeek.setDate(date.getDate() - dayOfWeek);
            startOfWeek.setHours(0, 0, 0, 0);
            
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            endOfWeek.setHours(23, 59, 59, 999);
            
            return { start: startOfWeek, end: endOfWeek };
        }

        // 格式化周范围显示
        function formatWeekRange(start, end) {
            const options = { month: 'short', day: 'numeric' };
            return `${start.toLocaleDateString('zh-CN', options)} - ${end.toLocaleDateString('zh-CN', options)}`;
        }

        // 检查消息是否在当前周
        function isCurrentWeek(messageDate) {
            const currentWeek = getCurrentWeekRange();
            return messageDate >= currentWeek.start && messageDate <= currentWeek.end;
        }

        // 获取当前周消息
        function getCurrentWeekMessages() {
            return allMessages.filter(msg => isCurrentWeek(new Date(msg.timestamp)));
        }

        // 获取历史消息（按周分组）
        function getHistoryMessages() {
            const historyMessages = allMessages.filter(msg => !isCurrentWeek(new Date(msg.timestamp)));
            const messagesByWeek = {};
            
            historyMessages.forEach(msg => {
                const msgDate = new Date(msg.timestamp);
                const weekRange = getWeekRange(msgDate);
                const weekKey = `${weekRange.start.getTime()}-${weekRange.end.getTime()}`;
                
                if (!messagesByWeek[weekKey]) {
                    messagesByWeek[weekKey] = {
                        start: weekRange.start,
                        end: weekRange.end,
                        messages: []
                    };
                }
                
                messagesByWeek[weekKey].messages.push(msg);
            });
            
            // 按时间倒序排列（最新的周在前面）
            return Object.values(messagesByWeek).sort((a, b) => b.start.getTime() - a.start.getTime());
        }

        // 安全的localStorage操作
        function saveMessages() {
            try {
                localStorage.setItem('coupleMessages', JSON.stringify(allMessages));
            } catch (e) {
                console.log('无法保存到localStorage，使用内存存储');
            }
        }

        function loadMessages() {
            try {
                const saved = localStorage.getItem('coupleMessages');
                if (saved) {
                    allMessages = JSON.parse(saved);
                    // 确保所有消息都有有效的时间戳
                    allMessages.forEach(msg => {
                        if (typeof msg.timestamp === 'string' && !msg.timestamp.includes('T')) {
                            // 转换旧格式的时间戳
                            msg.timestamp = new Date(msg.timestamp).toISOString();
                        }
                    });
                }
            } catch (e) {
                console.log('无法从localStorage读取，使用空数组');
                allMessages = [];
            }
        }

        // 初始化应用
        function initApp() {
            loadMessages();
            updateWeekInfo();
            displayCurrentMessages();
            // ===== 新增：初始化心情和食物模块 =====
            loadTodayMood();
            loadTodayFood();
            updateMoodPermissions(); // 新增：更新权限控制
        }

        // 更新周信息
        function updateWeekInfo() {
            const weekInfo = document.getElementById('weekInfo');
            const currentWeek = getCurrentWeekRange();
            const currentMessages = getCurrentWeekMessages();
            
            weekInfo.innerHTML = `
                📅 本周对话 (${formatWeekRange(currentWeek.start, currentWeek.end)}) 
                <br>共 ${currentMessages.length} 条消息
            `;
        }

        // 显示当前周消息
        function showCurrent() {
            document.getElementById('mainContainer').style.display = 'block';
            document.getElementById('historyContainer').style.display = 'none';
            document.getElementById('currentBtn').classList.add('active');
            document.getElementById('historyBtn').classList.remove('active');
            displayCurrentMessages();
        }

        // 显示历史记录
        function showHistory() {
            document.getElementById('mainContainer').style.display = 'none';
            document.getElementById('historyContainer').style.display = 'block';
            document.getElementById('currentBtn').classList.remove('active');
            document.getElementById('historyBtn').classList.add('active');
            displayHistoryMessages();
        }

        // 修改：登录功能 - 支持不区分大小写
        function login() {
            const username = document.getElementById('username').value.trim().toLowerCase(); // 转换为小写
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('loginError');

            if (!username || !password) {
                errorDiv.textContent = '请输入用户名和密码';
                return;
            }

            // 查找用户时也转换为小写比较
            const foundUser = Object.keys(users).find(key => key.toLowerCase() === username);
            
            if (foundUser && users[foundUser].password === password) {
                currentUser = foundUser; // 使用原始的用户名（保持大小写）
                showMainInterface();
                errorDiv.textContent = '';
            } else {
                errorDiv.textContent = '用户名或密码错误';
            }
        }

        // 显示主界面
        function showMainInterface() {
            // 添加登录后的背景样式
            document.body.classList.add('logged-in');
            
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('mainContainer').style.display = 'block';
            
            const userAvatar = document.getElementById('userAvatar');
            const currentUserSpan = document.getElementById('currentUser');
            
            userAvatar.className = `avatar ${users[currentUser].avatar}`;
            currentUserSpan.textContent = users[currentUser].name;
            
            // ===== 新增：设置当前心情选择用户 =====
            moodCurrentUser = currentUser;
            
            initApp();
        }

        // 退出登录
        function logout() {
            // 移除登录后的背景样式
            document.body.classList.remove('logged-in');
            
            currentUser = null;
            document.getElementById('loginContainer').style.display = 'block';
            document.getElementById('mainContainer').style.display = 'none';
            document.getElementById('historyContainer').style.display = 'none';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('loginError').textContent = '';
        }

        // 发送消息
        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const content = messageInput.value.trim();

            if (!content) {
                alert('请输入消息内容');
                return;
            }

            const message = {
                user: currentUser,
                content: content,
                timestamp: new Date().toISOString()
            };

            allMessages.push(message);
            saveMessages();
            messageInput.value = '';
            updateWeekInfo();
            displayCurrentMessages();
        }

        // 显示当前周消息
        function displayCurrentMessages() {
            const messagesContainer = document.getElementById('messages');
            if (!messagesContainer) return;
            
            const currentMessages = getCurrentWeekMessages();
            messagesContainer.innerHTML = '';

            if (currentMessages.length === 0) {
                messagesContainer.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">本周还没有消息，快来发表第一条留言吧！💝</div>';
                return;
            }

            currentMessages.forEach(message => {
                const messageDiv = createMessageElement(message);
                messagesContainer.appendChild(messageDiv);
            });

            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // 显示历史消息
        function displayHistoryMessages() {
            const historyContent = document.getElementById('historyContent');
            const historyStats = document.getElementById('historyStats');
            const historyData = getHistoryMessages();
            
            historyContent.innerHTML = '';
            
            if (historyData.length === 0) {
                historyContent.innerHTML = '<div style="text-align: center; color: #999; padding: 40px;">还没有历史记录 📭</div>';
                historyStats.textContent = '总计: 0 条历史消息';
                return;
            }

            const totalHistoryMessages = historyData.reduce((sum, week) => sum + week.messages.length, 0);
            historyStats.textContent = `总计: ${totalHistoryMessages} 条历史消息，${historyData.length} 周`;

            historyData.forEach((weekData, index) => {
                const weekSection = document.createElement('div');
                weekSection.className = 'week-section';
                
                const weekHeader = document.createElement('div');
                weekHeader.className = 'week-header';
                weekHeader.innerHTML = `
                    <span>📅 ${formatWeekRange(weekData.start, weekData.end)} (${weekData.messages.length} 条消息)</span>
                    <span class="expand-icon">▶</span>
                `;
                
                const weekMessages = document.createElement('div');
                weekMessages.className = 'week-messages';
                
                weekData.messages.forEach(message => {
                    const messageDiv = createMessageElement(message);
                    weekMessages.appendChild(messageDiv);
                });
                
                weekHeader.onclick = function() {
                    const isExpanded = weekMessages.classList.contains('expanded');
                    weekMessages.classList.toggle('expanded');
                    weekHeader.classList.toggle('expanded');
                    const icon = weekHeader.querySelector('.expand-icon');
                    icon.classList.toggle('expanded');
                };
                
                weekSection.appendChild(weekHeader);
                weekSection.appendChild(weekMessages);
                historyContent.appendChild(weekSection);
            });
        }

        // 创建消息元素
        function createMessageElement(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${message.user}`;
            
            const messageTime = new Date(message.timestamp).toLocaleString('zh-CN');
            
            messageDiv.innerHTML = `
                <div class="message-header">
                    <div class="message-avatar ${users[message.user].avatar}"></div>
                    <span class="message-user">${users[message.user].name}</span>
                    <span class="message-time">${messageTime}</span>
                </div>
                <div class="message-content">${message.content}</div>
            `;
            
            return messageDiv;
        }

        // ===== 新增：权限控制函数 =====
        function updateMoodPermissions() {
            const poMood = document.getElementById('po-mood');
            const mankitMood = document.getElementById('mankit-mood');
            
            // 移除所有权限类
            poMood.classList.remove('clickable');
            mankitMood.classList.remove('clickable');
            
            // 只有当前用户可以点击自己的头像
            if (currentUser === 'po') {
                poMood.classList.add('clickable');
            } else if (currentUser === 'mankit') {
                mankitMood.classList.add('clickable');
            }
        }

        // ===== 新增：心情功能函数 =====
        function toggleMoodSelector() {
            const selector = document.getElementById('mood-selector');
            selector.classList.toggle('show');
        }

        // 修改：删除提醒弹窗，保留权限控制逻辑
        function setCurrentUser(user) {
            if (user !== currentUser) {
                return;
            }
            moodCurrentUser = user;
            const selector = document.getElementById('mood-selector');
            selector.classList.add('show');
        }

        function selectMood(moodType) {
            // 确保只能设置自己的心情
            if (moodCurrentUser !== currentUser) {
                return;
            }

            const moodGifs = {
                'angry': ['dailyemo/angry1.gif', 'dailyemo/angry2.gif'],
                'hateu': ['dailyemo/hateu.gif'],
                'sad': ['dailyemo/sad.gif'],
                'happy': ['dailyemo/happy1.gif', 'dailyemo/happy2.gif'],
                'proud': ['dailyemo/proud1.gif', 'dailyemo/proud2.gif', 'dailyemo/proud3.gif'],
                'normal': ['dailyemo/normal.gif'],
                'loveu': ['dailyemo/loveu.gif'],
                'sleepy': ['dailyemo/sleepy.gif'],
                'weak': ['dailyemo/weak.gif'],
                'hardwork': ['dailyemo/hardwork2.gif', 'dailyemo/harkwork1.gif']
            };

            // 随机选择同类型的gif
            const gifs = moodGifs[moodType] || ['dailyemo/normal.gif'];
            const randomGif = gifs[Math.floor(Math.random() * gifs.length)];
            
            // 更新当前用户的心情显示
            const userMoodImg = document.getElementById(currentUser + '-mood');
            userMoodImg.src = randomGif + '?t=' + Date.now(); // 添加时间戳强制重新加载
            
            // 强制重新加载GIF以确保动画播放
            userMoodImg.onload = function() {
                this.style.animationPlayState = 'running';
            };
            
            // 保存到本地存储
            const today = new Date().toDateString();
            localStorage.setItem(`${currentUser}_mood_${today}`, randomGif);
            
            // 关闭选择器
            document.getElementById('mood-selector').classList.remove('show');
            
            // 保存到历史记录
            saveMoodHistory(currentUser, moodType, randomGif);
        }

        function saveMoodHistory(user, moodType, gif) {
            const today = new Date().toDateString();
            let history = JSON.parse(localStorage.getItem('mood_history') || '{}');
            
            if (!history[today]) {
                history[today] = {};
            }
            
            history[today][user] = {
                type: moodType,
                gif: gif,
                timestamp: new Date().toISOString()
            };
            
            localStorage.setItem('mood_history', JSON.stringify(history));
        }

        function showMoodHistory() {
            const history = JSON.parse(localStorage.getItem('mood_history') || '{}');
            let historyText = '📊 最近7天心情历史:\n\n';
            
            const dates = Object.keys(history).sort().slice(-7);
            dates.forEach(date => {
                historyText += `${date}:\n`;
                if (history[date].po) historyText += `  Po: ${history[date].po.type}\n`;
                if (history[date].mankit) historyText += `  Mankit: ${history[date].mankit.type}\n`;
                historyText += '\n';
            });
            
            if (dates.length === 0) {
                historyText = '还没有心情记录哦~ 💭';
            }
            
            alert(historyText);
        }

        // 修改：加载今日心情并强制播放动画
        function loadTodayMood() {
            const today = new Date().toDateString();
            
            // 恢复Po的心情
            const poMood = localStorage.getItem(`po_mood_${today}`);
            if (poMood) {
                const poImg = document.getElementById('po-mood');
                poImg.src = poMood + '?t=' + Date.now(); // 添加时间戳强制重新加载
                // 强制重新加载以确保动画播放
                poImg.onload = function() {
                    this.style.animationPlayState = 'running';
                };
            }
            
            // 恢复Mankit的心情
            const mankitMood = localStorage.getItem(`mankit_mood_${today}`);
            if (mankitMood) {
                const mankitImg = document.getElementById('mankit-mood');
                mankitImg.src = mankitMood + '?t=' + Date.now(); // 添加时间戳强制重新加载
                // 强制重新加载以确保动画播放
                mankitImg.onload = function() {
                    this.style.animationPlayState = 'running';
                };
            }
        }

        // ===== 新增：今天吃什么功能函数 =====
        function toggleFoodOptions() {
            const options = document.getElementById('food-options');
            options.classList.toggle('show');
        }

        function selectFood(foodType) {
            const foodOptions = {
                '中餐': ['宫保鸡丁', '红烧肉', '麻婆豆腐', '糖醋里脊', '鱼香肉丝', '回锅肉', '水煮鱼', '白切鸡'],
                '西餐': ['牛排', '意大利面', '披萨', '汉堡', '沙拉', '焗饭', '浓汤', '烤鸡'],
                '日料': ['寿司', '拉面', '天妇罗', '刺身', '日式咖喱', '鳗鱼饭', '味噌汤', '铁板烧'],
                '韩餐': ['韩式烤肉', '石锅拌饭', '泡菜汤', '炸鸡', '冷面', '辣炒年糕', '部队锅', '海鲜饼'],
                '火锅': ['四川火锅', '清汤火锅', '麻辣烫', '关东煮', '涮羊肉', '酸菜鱼火锅', '番茄火锅'],
                '烧烤': ['羊肉串', '烤鸡翅', '烤茄子', '烤玉米', '烤鱿鱼', '烤韭菜', '烤土豆'],
                '快餐': ['肯德基', '麦当劳', '汉堡王', 'Subway', '必胜客', '华莱士', '德克士'],
                '甜品': ['蛋糕', '冰淇淋', '布丁', '马卡龙', '泡芙', '提拉米苏', '慕斯', '芝士蛋糕'],
                '外卖': ['美团外卖推荐', '饿了么今日特价', '随机外卖探索', '附近热门餐厅'],
                '随机': []
            };

            let selectedFood;
            if (foodType === '随机') {
                const allFoods = Object.values(foodOptions).flat().filter(food => food);
                selectedFood = allFoods[Math.floor(Math.random() * allFoods.length)];
            } else {
                const foods = foodOptions[foodType];
                selectedFood = foods[Math.floor(Math.random() * foods.length)];
            }

            document.getElementById('food-display').innerHTML = `🎉 今天吃: <br><strong>${selectedFood}</strong>`;
            document.getElementById('food-options').classList.remove('show');
            
            // 保存选择
            const today = new Date().toDateString();
            localStorage.setItem(`food_choice_${today}`, selectedFood);
        }

        function loadTodayFood() {
            const today = new Date().toDateString();
            const foodChoice = localStorage.getItem(`food_choice_${today}`);
            if (foodChoice) {
                document.getElementById('food-display').innerHTML = `🎉 今天吃: <br><strong>${foodChoice}</strong>`;
            }
        }

        // 键盘事件监听
        document.addEventListener('DOMContentLoaded', function() {
            // 登录回车事件
            const passwordInput = document.getElementById('password');
            if (passwordInput) {
                passwordInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        login();
                    }
                });
            }

            // 消息发送回车事件
            const messageInput = document.getElementById('messageInput');
            if (messageInput) {
                messageInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
            }

            // ===== 新增：点击外部关闭面板 =====
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.mood-module')) {
                    document.getElementById('mood-selector').classList.remove('show');
                }
                if (!e.target.closest('.food-module')) {
                    document.getElementById('food-options').classList.remove('show');
                }
            });
        });
    </script>
</body>
</html>